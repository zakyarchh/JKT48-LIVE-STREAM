<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel | ikazz - 48</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #E85D75;
            --primary-light: #FF8A9B;
            --secondary: #7C6AEF;
            --accent: #2DCDA7;
            --danger: #EF4444;
            --dark: #1E1E2E;
            --gray-700: #4A4A5A;
            --gray-500: #6E6E7E;
            --gray-300: #A0A0B0;
            --gray-100: #F0F0F5;
            --white: #FFFFFF;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(180deg, #FFFFFF 0%, #F8F9FC 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary); } 50% { box-shadow: 0 0 15px var(--primary), 0 0 25px var(--primary); } }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .login-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 48px;
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.6s ease;
        }

        .login-header { text-align: center; margin-bottom: 36px; }

        .login-logo {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 28px;
            font-weight: 800;
            color: white;
        }

        .login-title { font-size: 26px; font-weight: 800; margin-bottom: 8px; }
        .login-subtitle { font-size: 14px; color: var(--gray-500); }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: var(--dark); margin-bottom: 8px; }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--gray-100);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-textarea { min-height: 100px; resize: vertical; }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(232, 93, 117, 0.1);
        }

        .btn-login, .btn-primary {
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-login { width: 100%; }

        .btn-login:hover, .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 93, 117, 0.4);
        }

        .btn-login:disabled, .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            padding: 12px 20px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover { background: #E8E8F0; }
        .btn-success { background: linear-gradient(135deg, var(--accent) 0%, #25B897 100%) !important; }
        .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #DC2626 100%) !important; }

        .btn-danger-outline {
            padding: 12px 20px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 2px solid var(--danger);
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-danger-outline:hover { background: var(--danger); color: white; }

        .admin-container { display: none; min-height: 100vh; }
        .admin-container.active { display: flex; }

        .sidebar {
            width: 280px;
            background: var(--white);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 100;
            animation: slideIn 0.5s ease;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--gray-100);
        }

        .sidebar-logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 16px;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-section { margin-bottom: 28px; }
        .nav-section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 4px;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 14px;
        }

        .nav-item:hover { background: var(--gray-100); color: var(--dark); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; }
        .nav-item i { width: 20px; text-align: center; }

        .btn-logout {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
            background: rgba(232, 93, 117, 0.1);
            border: none;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .btn-logout:hover { background: rgba(232, 93, 117, 0.2); }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 32px;
            animation: fadeIn 0.5s ease;
        }

        .page-header { margin-bottom: 28px; }
        .page-title { font-size: 26px; font-weight: 800; margin-bottom: 6px; }
        .page-subtitle { font-size: 14px; color: var(--gray-500); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            animation: fadeInUp 0.5s ease;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 16px;
        }

        .stat-icon.pink { background: rgba(232, 93, 117, 0.1); color: var(--primary); }
        .stat-icon.purple { background: rgba(124, 106, 239, 0.1); color: var(--secondary); }
        .stat-icon.green { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .stat-icon.orange { background: rgba(255, 159, 67, 0.1); color: #FF9F43; }

        .stat-value { font-size: 32px; font-weight: 800; margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: var(--gray-500); font-weight: 500; }

        .content-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            animation: fadeInUp 0.5s ease;
        }

        .content-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .content-card-title { 
            font-size: 18px; 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
        }

        th {
            font-weight: 600;
            color: var(--gray-500);
            font-size: 12px;
            text-transform: uppercase;
            background: #FAFBFC;
        }

        td { font-size: 14px; }
        tr:hover td { background: #FAFBFC; }

        code {
            background: var(--gray-100);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge.live { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .badge.offline { background: var(--gray-100); color: var(--gray-500); }
        .badge.active { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .badge.expired { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .badge.used { background: rgba(124, 106, 239, 0.1); color: var(--secondary); }

        .action-btns { display: flex; gap: 8px; }

        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        .btn-icon.copy { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .btn-icon.delete { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .btn-icon.edit { background: rgba(124, 106, 239, 0.1); color: var(--secondary); }
        .btn-icon.active { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .btn-icon:hover { transform: scale(1.1); }

        .stream-preview {
            background: #000;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/9;
            margin-bottom: 20px;
        }

        .stream-preview video { width: 100%; height: 100%; object-fit: cover; }

        .stream-status {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            padding: 8px 14px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stream-status.live { background: #EF4444; animation: pulse 2s infinite; }

        .stream-status .dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .viewer-count-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            padding: 8px 14px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stream-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .countdown-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            font-size: 120px;
            font-weight: 800;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .countdown-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .countdown-number {
            animation: pulse 1s infinite;
            text-shadow: 0 0 30px var(--primary);
        }

        .token-display {
            background: var(--gray-100);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: 600;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .btn-copy-sm {
            padding: 8px 14px;
            background: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-copy-sm:hover { background: var(--primary); color: white; }

        .page-section { display: none; }
        .page-section.active { display: block; }

        /* Lineup Styles */
        .lineup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .member-card {
            background: var(--gray-100);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .member-card.active {
            border-color: var(--primary);
            background: rgba(232, 93, 117, 0.05);
            animation: glow 2s infinite;
        }

        .member-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .member-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 12px;
            overflow: hidden;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            position: relative;
        }

        .member-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .online-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            border: 2px solid var(--white);
        }

        .member-name { font-weight: 600; margin-bottom: 4px; }
        .member-role { font-size: 12px; color: var(--gray-500); margin-bottom: 8px; }
        .member-status { font-size: 11px; color: var(--gray-500); }

        .member-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        /* Now Performing */
        .now-performing-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--radius-lg);
            padding: 24px;
            color: white;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .now-performing-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent 0%, rgba(255,255,255,0.1) 100%);
        }

        .now-performing-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .now-performing-label i { font-size: 14px; }

        .now-performing-name {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .now-performing-role {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .now-performing-actions {
            display: flex;
            gap: 12px;
        }

        /* Analytics Cards */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .analytics-card {
            background: var(--gray-100);
            border-radius: var(--radius-md);
            padding: 16px;
        }

        .analytics-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .analytics-label {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* Mobile Tabs */
        .mobile-tabs {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-100);
            padding: 8px 16px;
            z-index: 98;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            border-radius: var(--radius-md);
            color: var(--gray-500);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-item i { font-size: 20px; }
        .tab-item.active { color: var(--primary); background: rgba(232, 93, 117, 0.1); }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--white);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 520px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 28px;
            transform: scale(0.9) translateY(20px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .modal { transform: scale(1) translateY(0); }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title { font-size: 20px; font-weight: 700; }

        .btn-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--gray-100);
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            color: var(--gray-500);
            transition: all 0.3s ease;
        }

        .btn-close:hover { background: #E8E8F0; transform: rotate(90deg); }

        .modal-body { margin-bottom: 24px; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; }

        .photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 16px;
            overflow: hidden;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--gray-500);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-modal-icon {
            width: 80px;
            height: 80px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 36px;
            color: var(--danger);
            animation: shake 0.5s ease;
        }

        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }

        .toast {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            animation: fadeInUp 0.4s ease;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }

        .toast.error { border-left-color: #EF4444; }

        .toast-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .toast.success .toast-icon { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .toast.error .toast-icon { background: rgba(239, 68, 68, 0.1); color: #EF4444; }

        .toast-content h4 { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
        .toast-content p { font-size: 13px; color: var(--gray-500); }

        .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .empty-state { text-align: center; padding: 48px 20px; color: var(--gray-500); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }

        .debug-log {
            background: #1a1a2e;
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .debug-log .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #a0a0b0;
        }

        .debug-log .log-entry.success { color: var(--accent); }
        .debug-log .log-entry.error { color: var(--danger); }
        .debug-log .log-entry.info { color: var(--secondary); }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 20px 16px 80px; }
            .mobile-menu-btn { display: flex !important; }
            .mobile-tabs { display: flex; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .lineup-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 16px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 22px;
            cursor: pointer;
            z-index: 99;
            box-shadow: 0 4px 20px rgba(232, 93, 117, 0.4);
            align-items: center;
            justify-content: center;
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            display: none;
        }
        .sidebar-overlay.active { display: block; }

        .drag-handle {
            cursor: grab;
            color: var(--gray-500);
            font-size: 16px;
            padding: 4px;
        }

        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- Countdown Overlay -->
    <div class="countdown-overlay" id="countdownOverlay">
        <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <!-- Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">48</div>
                <h1 class="login-title">Admin Panel</h1>
                <p class="login-subtitle">Masuk untuk mengelola ikazz - 48</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="adminEmail" placeholder="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="adminPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button type="submit" class="btn-login" id="btnLogin">
                    <i class="fas fa-sign-in-alt"></i> Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-container" id="adminContainer">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">48</div>
                <span class="sidebar-logo-text">ikazz - 48</span>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Menu</div>
                <div class="nav-item active" onclick="showPage('dashboard', this)">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                <div class="nav-item" onclick="showPage('liveControl', this)">
                    <i class="fas fa-broadcast-tower"></i> Live Control
                </div>
                <div class="nav-item" onclick="showPage('rooms', this)">
                    <i class="fas fa-door-open"></i> Kelola Room
                </div>
                <div class="nav-item" onclick="showPage('lineup', this)">
                    <i class="fas fa-users"></i> Lineup
                </div>
                <div class="nav-item" onclick="showPage('analytics', this)">
                    <i class="fas fa-chart-line"></i> Analytics
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Token</div>
                <div class="nav-item" onclick="showPage('membership', this)">
                    <i class="fas fa-crown"></i> Token Membership
                </div>
                <div class="nav-item" onclick="showPage('watchTokens', this)">
                    <i class="fas fa-ticket-alt"></i> Token Nonton
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Data</div>
                <div class="nav-item" onclick="showPage('users', this)">
                    <i class="fas fa-users"></i> Users
                </div>
            </div>

            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Keluar
            </button>
        </aside>

        <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Mobile Tabs -->
        <div class="mobile-tabs">
            <div class="tab-item active" onclick="showMobileTab('liveControl')">
                <i class="fas fa-broadcast-tower"></i>
                <span>Live</span>
            </div>
            <div class="tab-item" onclick="showMobileTab('rooms')">
                <i class="fas fa-door-open"></i>
                <span>Room</span>
            </div>
            <div class="tab-item" onclick="showMobileTab('lineup')">
                <i class="fas fa-users"></i>
                <span>Lineup</span>
            </div>
            <div class="tab-item" onclick="showMobileTab('analytics')">
                <i class="fas fa-chart-line"></i>
                <span>Stats</span>
            </div>
        </div>

        <main class="main-content">
            <!-- Dashboard -->
            <div class="page-section active" id="page-dashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Selamat datang di panel admin ikazz - 48</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon pink"><i class="fas fa-video"></i></div>
                        <div class="stat-value" id="statLiveRooms">0</div>
                        <div class="stat-label">Room Live</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple"><i class="fas fa-eye"></i></div>
                        <div class="stat-value" id="statViewers">0</div>
                        <div class="stat-label">Total Viewers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-crown"></i></div>
                        <div class="stat-value" id="statMembers">0</div>
                        <div class="stat-label">Members Aktif</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fas fa-ticket-alt"></i></div>
                        <div class="stat-value" id="statTokens">0</div>
                        <div class="stat-label">Token Tersedia</div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title"><i class="fas fa-trash-alt" style="color: var(--danger);"></i> Danger Zone</h3>
                    </div>
                    <p style="color: var(--gray-500); margin-bottom: 20px; font-size: 14px;">Hapus semua data. Tindakan ini tidak dapat dibatalkan!</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <button class="btn-danger-outline" onclick="confirmDeleteAll('rooms')">
                            <i class="fas fa-door-open"></i> Hapus Semua Room
                        </button>
                        <button class="btn-danger-outline" onclick="confirmDeleteAll('membershipTokens')">
                            <i class="fas fa-crown"></i> Hapus Semua Token Membership
                        </button>
                        <button class="btn-danger-outline" onclick="confirmDeleteAll('watchTokens')">
                            <i class="fas fa-ticket-alt"></i> Hapus Semua Token Nonton
                        </button>
                        <button class="btn-danger-outline" onclick="confirmDeleteAll('users')">
                            <i class="fas fa-users"></i> Hapus Semua Users
                        </button>
                    </div>
                </div>
            </div>

            <!-- Live Control -->
            <div class="page-section" id="page-liveControl">
                <div class="page-header">
                    <h1 class="page-title">Live Control</h1>
                    <p class="page-subtitle">Kontrol dan monitor live streaming</p>
                </div>

                <!-- Room Selector -->
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title"><i class="fas fa-door-open"></i> Pilih Room</h3>
                    </div>
                    <div class="form-group">
                        <select class="form-select" id="liveRoomSelect" onchange="loadRoomData()">
                            <option value="">-- Pilih Room --</option>
                        </select>
                    </div>
                </div>

                <!-- Live Preview & Status -->
                <div class="content-card" id="liveControlPanel" style="display: none;">
                    <div class="content-card-header">
                        <h3 class="content-card-title"><i class="fas fa-broadcast-tower"></i> Live Preview</h3>
                        <div class="header-actions">
                            <span class="badge live" id="liveStatusBadge">OFFLINE</span>
                        </div>
                    </div>

                    <!-- Video Preview -->
                    <div class="stream-preview">
                        <video id="adminVideo" autoplay muted playsinline></video>
                        <div class="stream-status" id="adminStreamStatus">
                            <span>Offline</span>
                        </div>
                        <div class="viewer-count-badge" id="adminViewerBadge" style="display: none;">
                            <i class="fas fa-eye"></i>
                            <span id="adminViewerCount">0</span> viewers
                        </div>
                    </div>

                    <!-- Live Info -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin: 16px 0;">
                        <div>
                            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">Started At</div>
                            <div style="font-weight: 600;" id="liveStartTime">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">Duration</div>
                            <div style="font-weight: 600;" id="liveDuration">00:00:00</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--gray-500); margin-bottom: 4px;">Viewers</div>
                            <div style="font-weight: 600;" id="liveViewers">0</div>
                        </div>
                    </div>

                    <!-- Stream Controls -->
                    <div class="stream-controls">
                        <button class="btn-primary btn-success" onclick="startScreenShare()">
                            <i class="fas fa-desktop"></i> Screen
                        </button>
                        <button class="btn-primary" onclick="startCameraShare()">
                            <i class="fas fa-camera"></i> Camera
                        </button>
                        <button class="btn-primary" onclick="startLiveWithCountdown()" id="btnGoLive">
                            <i class="fas fa-broadcast-tower"></i> Go Live
                        </button>
                        <button class="btn-primary btn-danger" onclick="stopLive()" id="btnStopLive" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Live
                        </button>
                    </div>

                    <!-- Emergency Controls -->
                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button class="btn-danger-outline" onclick="emergencyStop()" style="flex: 1;">
                            <i class="fas fa-exclamation-triangle"></i> Emergency Stop
                        </button>
                        <button class="btn-secondary" onclick="restartStream()" style="flex: 1;">
                            <i class="fas fa-sync"></i> Restart Stream
                        </button>
                    </div>

                    <!-- Debug Log -->
                    <div class="debug-log" id="adminDebugLog">
                        <div class="log-entry info">ðŸ“¡ Live Control Log</div>
                    </div>
                </div>

                <!-- Now Performing -->
                <div class="content-card" id="nowPerformingCard" style="display: none;">
                    <div class="now-performing-card">
                        <div class="now-performing-label">
                            <i class="fas fa-star"></i> NOW PERFORMING
                        </div>
                        <div class="now-performing-name" id="nowPerformingName">-</div>
                        <div class="now-performing-role" id="nowPerformingRole">-</div>
                        <div class="now-performing-actions">
                            <button class="btn-secondary" onclick="openModal('setPerformerModal')">
                                <i class="fas fa-edit"></i> Change
                            </button>
                            <button class="btn-danger-outline" onclick="clearActivePerformer()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rooms -->
            <div class="page-section" id="page-rooms">
                <div class="page-header">
                    <h1 class="page-title">Kelola Room</h1>
                    <p class="page-subtitle">Buat dan kelola room streaming</p>
                </div>

                <!-- Room List -->
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title"><i class="fas fa-list"></i> Daftar Room</h3>
                        <div class="header-actions">
                            <button class="btn-danger-outline" onclick="confirmDeleteAll('rooms')">
                                <i class="fas fa-trash-alt"></i> Hapus Semua
                            </button>
                            <button class="btn-primary" onclick="openModal('createRoomModal')">
                                <i class="fas fa-plus"></i> Buat Room
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Judul</th>
                                    <th>Status</th>
                                    <th>Viewers</th>
                                    <th>Performer</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="roomsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Edit Room Info -->
                <div class="content-card" id="editRoomPanel" style="display: none;">
                    <div class="content-card-header">
                        <h3 class="content-card-title"><i class="fas fa-edit"></i> Edit Room Info</h3>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Judul Room</label>
                        <input type="text" class="form-input" id="editRoomTitle" placeholder="Judul streaming">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subtitle</label>
                        <input type="text" class="form-input" id="editRoomSubtitle" placeholder="Subtitle / deskripsi singkat">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deskripsi</label>
                        <textarea class="form-textarea" id="editRoomDescription" placeholder="Deskripsi lengkap room..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Thumbnail URL</label>
                        <input type="url" class="form-input" id="editRoomThumbnail" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategori</label>
                        <select class="form-select" id="editRoomCategory">
                            <option value="regular">Regular</option>
                            <option value="special">Special</option>
                            <option value="event">Event</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="updateRoomInfo()">
                        <i class="fas fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </div>

            <!-- Lineup Management -->
            <div class="page-section" id="page-lineup">
                <div class="page-header">
                    <h1 class="page-title">Lineup Management</h1>
                    <p class="page-subtitle">Kelola lineup member</p>
                </div>

                <!-- Room Selector for Lineup -->
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title"><i class="fas fa-door-open"></i> Pilih Room</h3>
                        <div class="header-actions">
                            <button class="btn-primary" onclick="openModal('createMemberModal')">
                                <i class="fas fa-plus"></i> Tambah Member
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <select class="form-select" id="lineupRoomSelect" onchange="loadLineup()">
                            <option value="">-- Pilih Room --</option>
                        </select>
                    </div>
                </div>

                <!-- Now Performing Summary -->
                <div class="content-card" id="nowPerformingSummary" style="display: none;">
                    <div class="now-performing-card" style="background: linear-gradient(135deg, var(--secondary) 0%, #9D8DF7 100%);">
                        <div class="now-performing-label">
                            <i class="fas fa-star"></i> CURRENT PERFORMER
                        </div>
                        <div class="now-performing-name" id="currentPerformerName">-</div>
                        <div class="now-performing-role" id="currentPerformerRole">-</div>
                    </div>
                </div>

                <!-- Lineup Grid -->
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title"><i class="fas fa-users"></i> Lineup Member</h3>
                        <div class="header-actions">
                            <button class="btn-secondary" onclick="saveLineupOrder()">
                                <i class="fas fa-save"></i> Simpan Urutan
                            </button>
                        </div>
                    </div>
                    <div class="lineup-grid" id="lineupGrid"></div>
                </div>
            </div>

            <!-- Analytics -->
            <div class="page-section" id="page-analytics">
                <div class="page-header">
                    <h1 class="page-title">Viewer Analytics</h1>
                    <p class="page-subtitle">Statistik realtime viewer</p>
                </div>

                <!-- Room Selector for Analytics -->
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title"><i class="fas fa-door-open"></i> Pilih Room</h3>
                    </div>
                    <div class="form-group">
                        <select class="form-select" id="analyticsRoomSelect" onchange="loadAnalytics()">
                            <option value="">-- Pilih Room --</option>
                        </select>
                    </div>
                </div>

                <!-- Analytics Stats -->
                <div class="content-card" id="analyticsPanel" style="display: none;">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-value" id="currentViewers">0</div>
                            <div class="analytics-label">Current Viewers</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="peakViewers">0</div>
                            <div class="analytics-label">Peak Viewers</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="totalViewers">0</div>
                            <div class="analytics-label">Total Viewers</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="activeViewers">0</div>
                            <div class="analytics-label">Active Documents</div>
                        </div>
                    </div>

                    <!-- Active Viewers List -->
                    <h3 style="margin: 24px 0 16px; font-size: 16px;">Active Viewers</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Device ID</th>
                                    <th>Connected Since</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="viewersListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Membership Tokens -->
            <div class="page-section" id="page-membership">
                <div class="page-header">
                    <h1 class="page-title">Token Membership</h1>
                    <p class="page-subtitle">Kelola token membership premium</p>
                </div>
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title">Daftar Token</h3>
                        <div class="header-actions">
                            <button class="btn-danger-outline" onclick="confirmDeleteAll('membershipTokens')">
                                <i class="fas fa-trash-alt"></i> Hapus Semua
                            </button>
                            <button class="btn-primary" onclick="openModal('createMembershipModal')">
                                <i class="fas fa-plus"></i> Buat Token
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Token</th><th>Durasi</th><th>Status</th><th>Expired</th><th>Aksi</th></tr></thead>
                            <tbody id="membershipTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Watch Tokens -->
            <div class="page-section" id="page-watchTokens">
                <div class="page-header">
                    <h1 class="page-title">Token Nonton</h1>
                    <p class="page-subtitle">Kelola token untuk menonton live</p>
                </div>
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title">Daftar Token</h3>
                        <div class="header-actions">
                            <button class="btn-danger-outline" onclick="confirmDeleteAll('watchTokens')">
                                <i class="fas fa-trash-alt"></i> Hapus Semua
                            </button>
                            <button class="btn-primary" onclick="openModal('createWatchTokenModal')">
                                <i class="fas fa-plus"></i> Buat Token
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Token</th><th>Room</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody id="watchTokensTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users -->
            <div class="page-section" id="page-users">
                <div class="page-header">
                    <h1 class="page-title">Users</h1>
                    <p class="page-subtitle">Lihat data pengguna</p>
                </div>
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title">Daftar Users</h3>
                        <div class="header-actions">
                            <button class="btn-danger-outline" onclick="confirmDeleteAll('users')">
                                <i class="fas fa-trash-alt"></i> Hapus Semua
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Nama</th><th>WhatsApp</th><th>Gender</th><th>Token</th><th>Status</th></tr></thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- Create Room Modal -->
    <div class="modal-overlay" id="createRoomModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Buat Room Baru</h3>
                <button class="btn-close" onclick="closeModal('createRoomModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nama Member</label>
                    <input type="text" class="form-input" id="roomMemberName" placeholder="Contoh: Shani JKT48" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Judul Stream</label>
                    <input type="text" class="form-input" id="roomTitle" placeholder="Contoh: Cuap-cuap Sore" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Subtitle</label>
                    <input type="text" class="form-input" id="roomSubtitle" placeholder="Deskripsi singkat">
                </div>
                <div class="form-group">
                    <label class="form-label">Thumbnail URL (opsional)</label>
                    <input type="url" class="form-input" id="roomThumbnail" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label">Kategori</label>
                    <select class="form-select" id="roomCategory">
                        <option value="regular">Regular</option>
                        <option value="special">Special</option>
                        <option value="event">Event</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('createRoomModal')">Batal</button>
                <button class="btn-primary" onclick="createRoom()"><i class="fas fa-plus"></i> Buat</button>
            </div>
        </div>
    </div>

    <!-- Create Member Modal -->
    <div class="modal-overlay" id="createMemberModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Tambah Member Lineup</h3>
                <button class="btn-close" onclick="closeModal('createMemberModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="photo-preview" id="memberPhotoPreview">
                    <i class="fas fa-user"></i>
                </div>
                <div class="form-group">
                    <label class="form-label">Nama Member</label>
                    <input type="text" class="form-input" id="memberName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Photo URL</label>
                    <input type="url" class="form-input" id="memberPhoto" placeholder="https://..." onchange="previewMemberPhoto()">
                </div>
                <div class="form-group">
                    <label class="form-label">Role / Posisi</label>
                    <input type="text" class="form-input" id="memberRole" placeholder="Contoh: Kapten, Member, dll">
                </div>
                <div class="form-group">
                    <label class="form-label">Deskripsi</label>
                    <textarea class="form-textarea" id="memberDescription" placeholder="Deskripsi member..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Urutan Tampil</label>
                    <input type="number" class="form-input" id="memberOrder" value="0" min="0">
                </div>
                <div style="display: flex; gap: 20px; margin: 16px 0;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="memberOnline" checked> Online
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="memberActive"> Sedang Tampil
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('createMemberModal')">Batal</button>
                <button class="btn-primary" onclick="createMember()"><i class="fas fa-plus"></i> Tambah</button>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div class="modal-overlay" id="editMemberModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Member</h3>
                <button class="btn-close" onclick="closeModal('editMemberModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editMemberId">
                <div class="photo-preview" id="editMemberPhotoPreview">
                    <i class="fas fa-user"></i>
                </div>
                <div class="form-group">
                    <label class="form-label">Nama Member</label>
                    <input type="text" class="form-input" id="editMemberName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Photo URL</label>
                    <input type="url" class="form-input" id="editMemberPhoto" onchange="previewEditMemberPhoto()">
                </div>
                <div class="form-group">
                    <label class="form-label">Role / Posisi</label>
                    <input type="text" class="form-input" id="editMemberRole">
                </div>
                <div class="form-group">
                    <label class="form-label">Deskripsi</label>
                    <textarea class="form-textarea" id="editMemberDescription"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Urutan Tampil</label>
                    <input type="number" class="form-input" id="editMemberOrder" min="0">
                </div>
                <div style="display: flex; gap: 20px; margin: 16px 0;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="editMemberOnline"> Online
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="editMemberActive"> Sedang Tampil
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('editMemberModal')">Batal</button>
                <button class="btn-primary" onclick="updateMember()"><i class="fas fa-save"></i> Simpan</button>
            </div>
        </div>
    </div>

    <!-- Set Performer Modal -->
    <div class="modal-overlay" id="setPerformerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Pilih Performer Aktif</h3>
                <button class="btn-close" onclick="closeModal('setPerformerModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Pilih Member</label>
                    <select class="form-select" id="performerSelect">
                        <option value="">-- Pilih Member --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('setPerformerModal')">Batal</button>
                <button class="btn-primary" onclick="setActivePerformer()"><i class="fas fa-check"></i> Set Active</button>
            </div>
        </div>
    </div>

    <!-- Create Membership Token Modal -->
    <div class="modal-overlay" id="createMembershipModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Buat Token Membership</h3>
                <button class="btn-close" onclick="closeModal('createMembershipModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Durasi (Bulan)</label>
                    <select class="form-select" id="membershipDuration">
                        <option value="1">1 Bulan</option>
                        <option value="3">3 Bulan</option>
                        <option value="6">6 Bulan</option>
                        <option value="12">12 Bulan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Jumlah Token</label>
                    <input type="number" class="form-input" id="membershipCount" value="1" min="1" max="50">
                </div>
                <div id="generatedMembershipTokens" style="display: none;">
                    <label class="form-label">Token yang Dibuat:</label>
                    <div id="membershipTokensList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('createMembershipModal')">Tutup</button>
                <button class="btn-primary" onclick="createMembershipTokens()"><i class="fas fa-plus"></i> Generate</button>
            </div>
        </div>
    </div>

    <!-- Create Watch Token Modal -->
    <div class="modal-overlay" id="createWatchTokenModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Buat Token Nonton</h3>
                <button class="btn-close" onclick="closeModal('createWatchTokenModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Pilih Room</label>
                    <select class="form-select" id="watchTokenRoom"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Jumlah Token</label>
                    <input type="number" class="form-input" id="watchTokenCount" value="1" min="1" max="50">
                </div>
                <div id="generatedWatchTokens" style="display: none;">
                    <label class="form-label">Token yang Dibuat:</label>
                    <div id="watchTokensList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('createWatchTokenModal')">Tutup</button>
                <button class="btn-primary" onclick="createWatchTokens()"><i class="fas fa-plus"></i> Generate</button>
            </div>
        </div>
    </div>

    <!-- Delete All Modal -->
    <div class="modal-overlay" id="deleteAllModal">
        <div class="modal">
            <div class="modal-body" style="padding-top: 20px;">
                <div class="delete-modal-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <h3 class="delete-modal-title">Hapus Semua <span id="deleteCollectionName"></span>?</h3>
                <p class="delete-modal-text">
                    Anda akan menghapus <span class="delete-count" id="deleteCount">0</span> data.
                    <br>Tindakan ini tidak dapat dibatalkan!
                </p>
                <div class="delete-modal-warning">
                    <p><i class="fas fa-exclamation-circle"></i> Semua data akan dihapus secara permanen</p>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn-secondary" onclick="closeModal('deleteAllModal')" style="flex: 1;">Batal</button>
                <button class="btn-primary btn-danger" onclick="executeDeleteAll()" id="btnConfirmDelete" style="flex: 1;">
                    <i class="fas fa-trash-alt"></i> Hapus Semua
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAl6WmsHrmYkyotYYu_VIEqX5buTrMa-ec",
            authDomain: "live-abd72.firebaseapp.com",
            projectId: "live-abd72",
            storageBucket: "live-abd72.firebasestorage.app",
            messagingSenderId: "705044265931",
            appId: "1:705044265931:web:402b9615df1d38863f944e"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==================== STATE ====================
        let localStream = null;
        let currentRoomId = null;
        let isLive = false;
        let pendingDeleteCollection = null;
        let durationInterval = null;
        let streamStartTime = null;
        let unsubscribers = [];
        let lineupUnsubscriber = null;
        let roomUnsubscriber = null;
        let viewersUnsubscriber = null;

        const collectionNames = {
            'rooms': 'Room',
            'membershipTokens': 'Token Membership',
            'watchTokens': 'Token Nonton',
            'users': 'User'
        };

        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ],
            iceCandidatePoolSize: 10
        };

        // ==================== DEBUG LOG ====================
        function adminLog(message, type = 'info') {
            const log = document.getElementById('adminDebugLog');
            if (!log) return;
            
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${time}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            console.log(`[ADMIN ${type.toUpperCase()}] ${message}`);
        }

        // ==================== AUTH ====================
        auth.onAuthStateChanged((user) => {
            if (user && user.email === 'ikazz@kazz.id') {
                showAdminPanel();
                loadDashboardData();
                loadRoomsForSelect();
            } else {
                showLoginPage();
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnLogin');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div> Memproses...';

            try {
                const email = document.getElementById('adminEmail').value;
                const password = document.getElementById('adminPassword').value;
                await auth.signInWithEmailAndPassword(email, password);
                if (auth.currentUser.email !== 'ikazz@kazz.id') {
                    await auth.signOut();
                    throw new Error('Unauthorized');
                }
                showToast('Sukses', 'Login berhasil!', 'success');
            } catch (error) {
                showToast('Error', error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Masuk';
            }
        });

        async function logout() { 
            await stopLive(); 
            await auth.signOut(); 
        }

        // ==================== UI FUNCTIONS ====================
        function showLoginPage() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').classList.remove('active');
        }

        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').classList.add('active');
        }

        function showPage(pageId, el) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (el) el.classList.add('active');

            // Load data based on page
            switch(pageId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'rooms':
                    loadRooms();
                    loadRoomsForSelect();
                    break;
                case 'lineup':
                    loadRoomsForSelect();
                    break;
                case 'analytics':
                    loadRoomsForSelect();
                    break;
                case 'membership':
                    loadMembershipTokens();
                    break;
                case 'watchTokens':
                    loadWatchTokens();
                    loadRoomsForSelect();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'liveControl':
                    loadRoomsForSelect();
                    break;
            }

            if (window.innerWidth <= 1024) {
                toggleSidebar();
                // Update mobile tab
                document.querySelectorAll('.tab-item').forEach(tab => {
                    tab.classList.toggle('active', tab.querySelector('span').textContent.toLowerCase().includes(pageId));
                });
            }
        }

        function showMobileTab(tabId) {
            showPage(tabId, null);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<div class="toast-icon"><i class="fas ${type === 'success' ? 'fa-check' : 'fa-exclamation'}"></i></div><div class="toast-content"><h4>${title}</h4><p>${message}</p></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // ==================== STREAMING FUNCTIONS ====================
        async function startScreenShare() {
            try {
                if (localStream) {
                    localStream.getTracks().forEach(t => t.stop());
                }
                
                localStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { cursor: 'always' }, 
                    audio: true 
                });
                
                document.getElementById('adminVideo').srcObject = localStream;
                document.getElementById('adminStreamStatus').innerHTML = '<span>Preview</span>';
                document.getElementById('adminStreamStatus').classList.remove('live');
                
                adminLog('Screen share started', 'success');
                showToast('Sukses', 'Screen share aktif', 'success');
                
                localStream.getVideoTracks()[0].onended = () => {
                    adminLog('Screen share stopped by user', 'info');
                    stopLocalStream();
                };
            } catch (error) { 
                adminLog('Screen share error: ' + error.message, 'error');
                showToast('Error', 'Gagal share screen: ' + error.message, 'error'); 
            }
        }

        async function startCameraShare() {
            try {
                if (localStream) {
                    localStream.getTracks().forEach(t => t.stop());
                }
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('adminVideo').srcObject = localStream;
                document.getElementById('adminStreamStatus').innerHTML = '<span>Preview</span>';
                document.getElementById('adminStreamStatus').classList.remove('live');
                
                adminLog('Camera started', 'success');
                showToast('Sukses', 'Camera aktif', 'success');
            } catch (error) { 
                adminLog('Camera error: ' + error.message, 'error');
                showToast('Error', 'Gagal akses camera: ' + error.message, 'error'); 
            }
        }

        function stopLocalStream() {
            if (localStream) { 
                localStream.getTracks().forEach(t => t.stop()); 
                localStream = null; 
            }
            document.getElementById('adminVideo').srcObject = null;
            document.getElementById('adminStreamStatus').innerHTML = '<span>Offline</span>';
            document.getElementById('adminStreamStatus').classList.remove('live');
        }

        // ==================== LIVE CONTROL ====================
        async function loadRoomData() {
            const roomId = document.getElementById('liveRoomSelect').value;
            
            if (!roomId) {
                document.getElementById('liveControlPanel').style.display = 'none';
                document.getElementById('nowPerformingCard').style.display = 'none';
                return;
            }

            currentRoomId = roomId;
            document.getElementById('liveControlPanel').style.display = 'block';

            // Load room info
            const roomDoc = await db.collection('rooms').doc(roomId).get();
            if (roomDoc.exists) {
                const data = roomDoc.data();
                document.getElementById('liveStatusBadge').textContent = data.isLive ? 'LIVE' : 'OFFLINE';
                document.getElementById('liveStatusBadge').className = data.isLive ? 'badge live' : 'badge offline';
                
                if (data.isLive) {
                    document.getElementById('btnGoLive').style.display = 'none';
                    document.getElementById('btnStopLive').style.display = 'inline-flex';
                    document.getElementById('adminViewerBadge').style.display = 'flex';
                    
                    if (data.startTime) {
                        streamStartTime = data.startTime.toDate();
                        document.getElementById('liveStartTime').textContent = streamStartTime.toLocaleTimeString();
                        startDurationCounter();
                    }
                } else {
                    document.getElementById('btnGoLive').style.display = 'inline-flex';
                    document.getElementById('btnStopLive').style.display = 'none';
                    document.getElementById('adminViewerBadge').style.display = 'none';
                    stopDurationCounter();
                }
            }

            // Load now performing
            await loadNowPerforming(roomId);
            document.getElementById('nowPerformingCard').style.display = 'block';

            // Setup realtime listeners
            setupRoomListener(roomId);
        }

        function setupRoomListener(roomId) {
            // Cleanup previous listeners
            if (roomUnsubscriber) roomUnsubscriber();
            if (viewersUnsubscriber) viewersUnsubscriber();

            // Room listener
            roomUnsubscriber = db.collection('rooms').doc(roomId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('adminViewerCount').textContent = data.viewerCount || 0;
                        document.getElementById('liveViewers').textContent = data.viewerCount || 0;
                        
                        if (data.isLive && data.startTime) {
                            streamStartTime = data.startTime.toDate();
                            document.getElementById('liveStartTime').textContent = streamStartTime.toLocaleTimeString();
                            startDurationCounter();
                        }
                    }
                });

            // Viewers listener for analytics
            viewersUnsubscriber = db.collection('rooms').doc(roomId)
                .collection('viewers')
                .onSnapshot((snapshot) => {
                    document.getElementById('activeViewersCount').textContent = snapshot.size;
                });
        }

        function startDurationCounter() {
            stopDurationCounter();
            durationInterval = setInterval(updateDuration, 1000);
            updateDuration();
        }

        function stopDurationCounter() {
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
            document.getElementById('liveDuration').textContent = '00:00:00';
        }

        function updateDuration() {
            if (!streamStartTime) return;
            
            const now = new Date();
            const diff = Math.floor((now - streamStartTime) / 1000);
            
            const hours = Math.floor(diff / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
            const seconds = (diff % 60).toString().padStart(2, '0');
            
            document.getElementById('liveDuration').textContent = `${hours}:${minutes}:${seconds}`;
        }

        async function startLiveWithCountdown() {
            const roomId = currentRoomId;
            if (!roomId) { 
                showToast('Error', 'Pilih room dulu', 'error'); 
                return; 
            }
            if (!localStream) { 
                showToast('Error', 'Mulai screen/camera dulu', 'error'); 
                return; 
            }

            // Show countdown
            const overlay = document.getElementById('countdownOverlay');
            const numberEl = document.getElementById('countdownNumber');
            overlay.classList.add('active');

            for (let i = 3; i > 0; i--) {
                numberEl.textContent = i;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            overlay.classList.remove('active');
            await startLive(roomId);
        }

        async function startLive(roomId) {
            try {
                isLive = true;
                streamStartTime = new Date();
                
                adminLog(`Starting live on room: ${roomId}`, 'info');

                await db.collection('rooms').doc(roomId).update({ 
                    isLive: true, 
                    viewerCount: 0, 
                    startTime: firebase.firestore.FieldValue.serverTimestamp() 
                });

                adminLog('Room status updated to LIVE', 'success');

                // UI Updates
                document.getElementById('adminStreamStatus').innerHTML = '<span class="dot"></span><span>LIVE</span>';
                document.getElementById('adminStreamStatus').classList.add('live');
                document.getElementById('adminViewerBadge').style.display = 'flex';
                document.getElementById('btnGoLive').style.display = 'none';
                document.getElementById('btnStopLive').style.display = 'inline-flex';
                document.getElementById('liveStatusBadge').textContent = 'LIVE';
                document.getElementById('liveStatusBadge').className = 'badge live';
                document.getElementById('liveStartTime').textContent = streamStartTime.toLocaleTimeString();
                
                startDurationCounter();
                
                adminLog('Live streaming started!', 'success');
                showToast('Sukses', 'Live dimulai!', 'success');

            } catch (error) { 
                adminLog('Start live error: ' + error.message, 'error');
                showToast('Error', error.message, 'error'); 
                isLive = false;
            }
        }

        async function stopLive() {
            if (!currentRoomId) return;

            try {
                adminLog('Stopping live...', 'info');

                // Update room status
                await db.collection('rooms').doc(currentRoomId).update({ 
                    isLive: false 
                });

                // Cleanup viewers subcollection
                await deleteRoomSubcollections(currentRoomId);

                stopLocalStream();
                stopDurationCounter();
                
                streamStartTime = null;
                isLive = false;
                
                // UI Updates
                document.getElementById('btnGoLive').style.display = 'inline-flex';
                document.getElementById('btnStopLive').style.display = 'none';
                document.getElementById('adminViewerBadge').style.display = 'none';
                document.getElementById('liveStatusBadge').textContent = 'OFFLINE';
                document.getElementById('liveStatusBadge').className = 'badge offline';
                
                adminLog('Live stopped', 'success');
                showToast('Sukses', 'Live dihentikan', 'success');

            } catch (error) { 
                adminLog('Stop live error: ' + error.message, 'error');
                showToast('Error', error.message, 'error'); 
            }
        }

        async function emergencyStop() {
            if (confirm('Emergency Stop akan menghentikan live dan menghapus semua koneksi. Lanjutkan?')) {
                await stopLive();
            }
        }

        async function restartStream() {
            if (!currentRoomId) return;
            
            await stopLive();
            setTimeout(() => {
                if (localStream) {
                    startLive(currentRoomId);
                } else {
                    showToast('Info', 'Mulai screen/camera dulu', 'info');
                }
            }, 1000);
        }

        // ==================== NOW PERFORMING ====================
        async function loadNowPerforming(roomId) {
            try {
                const snapshot = await db.collection('rooms').doc(roomId)
                    .collection('lineup')
                    .where('isActive', '==', true)
                    .get();

                if (!snapshot.empty) {
                    const performer = snapshot.docs[0].data();
                    document.getElementById('nowPerformingName').textContent = performer.name;
                    document.getElementById('nowPerformingRole').textContent = performer.role || 'Member';
                    document.getElementById('currentPerformerName').textContent = performer.name;
                    document.getElementById('currentPerformerRole').textContent = performer.role || 'Member';
                } else {
                    document.getElementById('nowPerformingName').textContent = '-';
                    document.getElementById('nowPerformingRole').textContent = '-';
                    document.getElementById('currentPerformerName').textContent = '-';
                    document.getElementById('currentPerformerRole').textContent = '-';
                }

                // Load performer select
                const lineupSnapshot = await db.collection('rooms').doc(roomId)
                    .collection('lineup')
                    .orderBy('order')
                    .get();

                let options = '<option value="">-- Pilih Member --</option>';
                lineupSnapshot.forEach(doc => {
                    const member = doc.data();
                    options += `<option value="${doc.id}">${member.name}</option>`;
                });
                document.getElementById('performerSelect').innerHTML = options;

            } catch (error) {
                adminLog('Error loading performer: ' + error.message, 'error');
            }
        }

        async function setActivePerformer() {
            const memberId = document.getElementById('performerSelect').value;
            if (!memberId || !currentRoomId) return;

            try {
                // Set all to false first
                const lineupRef = db.collection('rooms').doc(currentRoomId).collection('lineup');
                const snapshot = await lineupRef.get();
                
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.update(doc.ref, { isActive: false });
                });
                
                // Set selected to true
                batch.update(lineupRef.doc(memberId), { isActive: true });
                
                await batch.commit();
                
                closeModal('setPerformerModal');
                await loadNowPerforming(currentRoomId);
                showToast('Sukses', 'Performer aktif diupdate', 'success');
                
            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        async function clearActivePerformer() {
            if (!currentRoomId) return;
            
            try {
                const lineupRef = db.collection('rooms').doc(currentRoomId).collection('lineup');
                const snapshot = await lineupRef.get();
                
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.update(doc.ref, { isActive: false });
                });
                
                await batch.commit();
                await loadNowPerforming(currentRoomId);
                showToast('Sukses', 'Performer cleared', 'success');
                
            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        // ==================== LINEUP MANAGEMENT ====================
        async function loadLineup() {
            const roomId = document.getElementById('lineupRoomSelect').value;
            if (!roomId) return;

            try {
                const snapshot = await db.collection('rooms').doc(roomId)
                    .collection('lineup')
                    .orderBy('order')
                    .get();

                const grid = document.getElementById('lineupGrid');
                
                if (snapshot.empty) {
                    grid.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><br>Belum ada member</div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const member = doc.data();
                    html += `
                        <div class="member-card ${member.isActive ? 'active' : ''}" data-id="${doc.id}" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event)">
                            <div class="drag-handle" style="position: absolute; top: 8px; left: 8px;">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="member-photo">
                                ${member.photoURL 
                                    ? `<img src="${member.photoURL}" alt="${member.name}">`
                                    : `<i class="fas fa-user"></i>`
                                }
                                ${member.isOnline ? '<div class="online-dot"></div>' : ''}
                            </div>
                            <div class="member-name">${member.name}</div>
                            <div class="member-role">${member.role || 'Member'}</div>
                            <div class="member-status">${member.isOnline ? 'Online' : 'Offline'}</div>
                            <div class="member-actions">
                                <button class="btn-icon edit" onclick="editMember('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon ${member.isActive ? 'active' : 'copy'}" onclick="toggleActive('${doc.id}', ${member.isActive})">
                                    <i class="fas ${member.isActive ? 'fa-star' : 'fa-star'}"></i>
                                </button>
                                <button class="btn-icon delete" onclick="deleteMember('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });

                grid.innerHTML = html;

                // Load now performing summary
                document.getElementById('nowPerformingSummary').style.display = 'block';
                await loadNowPerforming(roomId);

            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        // Drag and drop for reordering
        let draggedItem = null;

        function dragStart(event) {
            draggedItem = event.target.closest('.member-card');
            event.dataTransfer.setData('text/plain', draggedItem.dataset.id);
            draggedItem.classList.add('dragging');
        }

        function dragOver(event) {
            event.preventDefault();
            const target = event.target.closest('.member-card');
            if (target && target !== draggedItem) {
                const grid = document.getElementById('lineupGrid');
                const items = [...grid.children];
                const fromIndex = items.indexOf(draggedItem);
                const toIndex = items.indexOf(target);
                
                if (fromIndex < toIndex) {
                    grid.insertBefore(draggedItem, target.nextSibling);
                } else {
                    grid.insertBefore(draggedItem, target);
                }
            }
        }

        function drop(event) {
            event.preventDefault();
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
        }

        async function saveLineupOrder() {
            const roomId = document.getElementById('lineupRoomSelect').value;
            if (!roomId) return;

            try {
                const cards = document.querySelectorAll('#lineupGrid .member-card');
                const batch = db.batch();
                const lineupRef = db.collection('rooms').doc(roomId).collection('lineup');

                cards.forEach((card, index) => {
                    const memberId = card.dataset.id;
                    batch.update(lineupRef.doc(memberId), { order: index });
                });

                await batch.commit();
                showToast('Sukses', 'Urutan lineup disimpan', 'success');

            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        async function createMember() {
            const roomId = document.getElementById('lineupRoomSelect').value;
            if (!roomId) {
                showToast('Error', 'Pilih room dulu', 'error');
                return;
            }

            const name = document.getElementById('memberName').value.trim();
            if (!name) {
                showToast('Error', 'Nama wajib diisi', 'error');
                return;
            }

            try {
                const memberData = {
                    name: name,
                    photoURL: document.getElementById('memberPhoto').value || null,
                    role: document.getElementById('memberRole').value || null,
                    description: document.getElementById('memberDescription').value || null,
                    order: parseInt(document.getElementById('memberOrder').value) || 0,
                    isOnline: document.getElementById('memberOnline').checked,
                    isActive: document.getElementById('memberActive').checked,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // If isActive true, set all others to false
                if (memberData.isActive) {
                    const lineupRef = db.collection('rooms').doc(roomId).collection('lineup');
                    const snapshot = await lineupRef.get();
                    
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { isActive: false });
                    });
                    
                    const newDocRef = lineupRef.doc();
                    batch.set(newDocRef, memberData);
                    await batch.commit();
                } else {
                    await db.collection('rooms').doc(roomId)
                        .collection('lineup')
                        .add(memberData);
                }

                closeModal('createMemberModal');
                document.getElementById('memberName').value = '';
                document.getElementById('memberPhoto').value = '';
                document.getElementById('memberRole').value = '';
                document.getElementById('memberDescription').value = '';
                document.getElementById('memberOrder').value = '0';
                document.getElementById('memberOnline').checked = true;
                document.getElementById('memberActive').checked = false;
                
                showToast('Sukses', 'Member ditambahkan', 'success');
                loadLineup();

            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        async function editMember(memberId) {
            const roomId = document.getElementById('lineupRoomSelect').value;
            if (!roomId) return;

            try {
                const doc = await db.collection('rooms').doc(roomId)
                    .collection('lineup').doc(memberId).get();

                if (doc.exists) {
                    const member = doc.data();
                    
                    document.getElementById('editMemberId').value = memberId;
                    document.getElementById('editMemberName').value = member.name || '';
                    document.getElementById('editMemberPhoto').value = member.photoURL || '';
                    document.getElementById('editMemberRole').value = member.role || '';
                    document.getElementById('editMemberDescription').value = member.description || '';
                    document.getElementById('editMemberOrder').value = member.order || 0;
                    document.getElementById('editMemberOnline').checked = member.isOnline || false;
                    document.getElementById('editMemberActive').checked = member.isActive || false;
                    
                    previewEditMemberPhoto();
                    
                    openModal('editMemberModal');
                }
            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        async function updateMember() {
            const roomId = document.getElementById('lineupRoomSelect').value;
            const memberId = document.getElementById('editMemberId').value;
            
            if (!roomId || !memberId) return;

            const name = document.getElementById('editMemberName').value.trim();
            if (!name) {
                showToast('Error', 'Nama wajib diisi', 'error');
                return;
            }

            try {
                const isActive = document.getElementById('editMemberActive').checked;

                // If isActive true, set all others to false
                if (isActive) {
                    const lineupRef = db.collection('rooms').doc(roomId).collection('lineup');
                    const snapshot = await lineupRef.get();
                    
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        if (doc.id !== memberId) {
                            batch.update(doc.ref, { isActive: false });
                        }
                    });
                    
                    batch.update(lineupRef.doc(memberId), {
                        name: name,
                        photoURL: document.getElementById('editMemberPhoto').value || null,
                        role: document.getElementById('editMemberRole').value || null,
                        description: document.getElementById('editMemberDescription').value || null,
                        order: parseInt(document.getElementById('editMemberOrder').value) || 0,
                        isOnline: document.getElementById('editMemberOnline').checked,
                        isActive: true
                    });
                    
                    await batch.commit();
                } else {
                    await db.collection('rooms').doc(roomId)
                        .collection('lineup')
                        .doc(memberId)
                        .update({
                            name: name,
                            photoURL: document.getElementById('editMemberPhoto').value || null,
                            role: document.getElementById('editMemberRole').value || null,
                            description: document.getElementById('editMemberDescription').value || null,
                            order: parseInt(document.getElementById('editMemberOrder').value) || 0,
                            isOnline: document.getElementById('editMemberOnline').checked,
                            isActive: false
                        });
                }

                closeModal('editMemberModal');
                showToast('Sukses', 'Member diupdate', 'success');
                loadLineup();
                if (currentRoomId === roomId) {
                    loadNowPerforming(roomId);
                }

            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        async function toggleActive(memberId, currentActive) {
            const roomId = document.getElementById('lineupRoomSelect').value;
            if (!roomId) return;

            try {
                if (!currentActive) {
                    // Set this as active, all others false
                    const lineupRef = db.collection('rooms').doc(roomId).collection('lineup');
                    const snapshot = await lineupRef.get();
                    
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { isActive: doc.id === memberId });
                    });
                    
                    await batch.commit();
                } else {
                    // Just set this to false
                    await db.collection('rooms').doc(roomId)
                        .collection('lineup')
                        .doc(memberId)
                        .update({ isActive: false });
                }

                showToast('Sukses', 'Status performer diupdate', 'success');
                loadLineup();
                if (currentRoomId === roomId) {
                    loadNowPerforming(roomId);
                }

            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        async function deleteMember(memberId) {
            if (!confirm('Yakin hapus member ini?')) return;

            const roomId = document.getElementById('lineupRoomSelect').value;
            if (!roomId) return;

            try {
                await db.collection('rooms').doc(roomId)
                    .collection('lineup')
                    .doc(memberId)
                    .delete();

                showToast('Sukses', 'Member dihapus', 'success');
                loadLineup();
                if (currentRoomId === roomId) {
                    loadNowPerforming(roomId);
                }

            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        // ==================== ANALYTICS ====================
        async function loadAnalytics() {
            const roomId = document.getElementById('analyticsRoomSelect').value;
            if (!roomId) {
                document.getElementById('analyticsPanel').style.display = 'none';
                return;
            }

            document.getElementById('analyticsPanel').style.display = 'block';

            try {
                // Current viewers from room doc
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                if (roomDoc.exists) {
                    document.getElementById('currentViewers').textContent = roomDoc.data().viewerCount || 0;
                }

                // Real-time viewers list
                const viewersRef = db.collection('rooms').doc(roomId).collection('viewers');
                
                // Get peak viewers (max from history - we'll just use current as peak for simplicity)
                const snapshot = await viewersRef.get();
                document.getElementById('activeViewers').textContent = snapshot.size;
                document.getElementById('totalViewers').textContent = snapshot.size;
                
                // Peak viewers (could be stored in room doc)
                document.getElementById('peakViewers').textContent = Math.max(roomDoc.data().viewerCount || 0, snapshot.size);

                // Load viewers list
                let html = '';
                snapshot.forEach(doc => {
                    const viewer = doc.data();
                    const time = viewer.createdAt?.toDate();
                    html += `
                        <tr>
                            <td><code>${doc.id.substring(0, 20)}...</code></td>
                            <td>${time ? time.toLocaleTimeString() : '-'}</td>
                            <td><span class="badge active">Active</span></td>
                        </tr>
                    `;
                });

                if (html === '') {
                    html = '<tr><td colspan="3" class="empty-state">Tidak ada viewer aktif</td></tr>';
                }

                document.getElementById('viewersListBody').innerHTML = html;

            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        // ==================== ROOM MANAGEMENT ====================
        async function createRoom() {
            const memberName = document.getElementById('roomMemberName').value.trim();
            const title = document.getElementById('roomTitle').value.trim();
            const subtitle = document.getElementById('roomSubtitle').value.trim();
            const thumbnail = document.getElementById('roomThumbnail').value.trim();
            const category = document.getElementById('roomCategory').value;

            if (!memberName || !title) { 
                showToast('Error', 'Nama dan judul wajib diisi', 'error'); 
                return; 
            }

            try {
                await db.collection('rooms').add({ 
                    memberName, 
                    title,
                    subtitle: subtitle || null,
                    description: null,
                    thumbnail: thumbnail || null, 
                    category: category,
                    isLive: false, 
                    viewerCount: 0, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });

                closeModal('createRoomModal');
                document.getElementById('roomMemberName').value = '';
                document.getElementById('roomTitle').value = '';
                document.getElementById('roomSubtitle').value = '';
                document.getElementById('roomThumbnail').value = '';
                
                showToast('Sukses', 'Room berhasil dibuat', 'success');
                loadRooms();
                loadRoomsForSelect();

            } catch (error) { 
                showToast('Error', error.message, 'error'); 
            }
        }

        async function editRoomInfo(roomId) {
            try {
                const doc = await db.collection('rooms').doc(roomId).get();
                if (doc.exists) {
                    const room = doc.data();
                    
                    document.getElementById('editRoomTitle').value = room.title || '';
                    document.getElementById('editRoomSubtitle').value = room.subtitle || '';
                    document.getElementById('editRoomDescription').value = room.description || '';
                    document.getElementById('editRoomThumbnail').value = room.thumbnail || '';
                    document.getElementById('editRoomCategory').value = room.category || 'regular';
                    
                    document.getElementById('editRoomPanel').style.display = 'block';
                    currentRoomId = roomId;
                }
            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        async function updateRoomInfo() {
            if (!currentRoomId) return;

            try {
                await db.collection('rooms').doc(currentRoomId).update({
                    title: document.getElementById('editRoomTitle').value,
                    subtitle: document.getElementById('editRoomSubtitle').value,
                    description: document.getElementById('editRoomDescription').value,
                    thumbnail: document.getElementById('editRoomThumbnail').value,
                    category: document.getElementById('editRoomCategory').value
                });

                showToast('Sukses', 'Room info diupdate', 'success');
                loadRooms();

            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        }

        async function loadRooms() {
            try {
                const snapshot = await db.collection('rooms').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('roomsTableBody');

                if (snapshot.empty) { 
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-door-open"></i><br>Belum ada room</td></tr>'; 
                    return; 
                }

                tbody.innerHTML = '';
                for (const doc of snapshot.docs) {
                    const r = doc.data();
                    
                    // Get active performer
                    let performerName = '-';
                    const lineupSnapshot = await db.collection('rooms').doc(doc.id)
                        .collection('lineup')
                        .where('isActive', '==', true)
                        .get();
                    
                    if (!lineupSnapshot.empty) {
                        performerName = lineupSnapshot.docs[0].data().name;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${r.memberName || '-'}</strong></td>
                            <td>${r.title || '-'}</td>
                            <td><span class="badge ${r.isLive ? 'live' : 'offline'}">${r.isLive ? 'LIVE' : 'Offline'}</span></td>
                            <td>${r.viewerCount || 0}</td>
                            <td>${performerName}</td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn-icon edit" onclick="editRoomInfo('${doc.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon delete" onclick="deleteRoom('${doc.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }

            } catch (error) { 
                showToast('Error', 'Gagal memuat rooms', 'error'); 
            }
        }

        async function deleteRoom(roomId) {
            if (!confirm('Yakin hapus room ini?')) return;
            try {
                await deleteRoomSubcollections(roomId);
                await db.collection('rooms').doc(roomId).delete();
                showToast('Sukses', 'Room dihapus', 'success');
                loadRooms();
                loadRoomsForSelect();
            } catch (error) { 
                showToast('Error', error.message, 'error'); 
            }
        }

        async function deleteRoomSubcollections(roomId) {
            try {
                // Delete lineup
                const lineupRef = db.collection('rooms').doc(roomId).collection('lineup');
                const lineup = await lineupRef.get();
                for (const doc of lineup.docs) {
                    await doc.ref.delete();
                }

                // Delete viewers and their subcollections
                const viewersRef = db.collection('rooms').doc(roomId).collection('viewers');
                const viewers = await viewersRef.get();
                
                for (const viewerDoc of viewers.docs) {
                    const viewerCands = await viewerDoc.ref.collection('viewerCandidates').get();
                    for (const cand of viewerCands.docs) await cand.ref.delete();
                    
                    const broadCands = await viewerDoc.ref.collection('broadcasterCandidates').get();
                    for (const cand of broadCands.docs) await cand.ref.delete();
                    
                    await viewerDoc.ref.delete();
                }
            } catch (error) { 
                console.error('Error deleting subcollections:', error); 
            }
        }

        // ==================== SELECT LOADERS ====================
        async function loadRoomsForSelect() {
            try {
                const snapshot = await db.collection('rooms').get();
                
                const selects = [
                    'liveRoomSelect',
                    'lineupRoomSelect',
                    'analyticsRoomSelect',
                    'watchTokenRoom'
                ];

                let options = '<option value="">-- Pilih Room --</option>';
                snapshot.forEach(doc => {
                    const r = doc.data();
                    options += `<option value="${doc.id}">${r.memberName} - ${r.title}</option>`;
                });

                selects.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = options;
                });

            } catch (error) { 
                console.error('Error loading rooms:', error); 
            }
        }

        // ==================== TOKEN FUNCTIONS ====================
        async function loadMembershipTokens() {
            try {
                const snapshot = await db.collection('membershipTokens').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('membershipTableBody');
                const now = new Date();

                if (snapshot.empty) { 
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-crown"></i><br>Belum ada token</td></tr>'; 
                    return; 
                }

                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const expiry = t.expiryDate?.toDate();
                    const isExpired = expiry && expiry < now;
                    const isActive = t.deviceId && !isExpired;
                    const status = isActive ? 'active' : (isExpired ? 'expired' : 'offline');
                    const statusText = isActive ? 'Aktif' : (isExpired ? 'Expired' : 'Tersedia');
                    
                    tbody.innerHTML += `
                        <tr>
                            <td><code>${doc.id}</code></td>
                            <td>${t.duration} Bulan</td>
                            <td><span class="badge ${status}">${statusText}</span></td>
                            <td>${expiry ? expiry.toLocaleDateString('id-ID') : '-'}</td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn-icon copy" onclick="copyToken('${doc.id}')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="btn-icon delete" onclick="deleteToken('membershipTokens', '${doc.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

            } catch (error) { 
                showToast('Error', 'Gagal memuat token', 'error'); 
            }
        }

        async function loadWatchTokens() {
            try {
                const snapshot = await db.collection('watchTokens').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('watchTokensTableBody');

                if (snapshot.empty) { 
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><i class="fas fa-ticket-alt"></i><br>Belum ada token</td></tr>'; 
                    return; 
                }

                tbody.innerHTML = '';
                for (const doc of snapshot.docs) {
                    const t = doc.data();
                    let roomName = '-';
                    
                    if (t.roomId) {
                        const roomDoc = await db.collection('rooms').doc(t.roomId).get();
                        if (roomDoc.exists) roomName = roomDoc.data().memberName;
                    }

                    const status = t.deviceId ? 'used' : 'active';
                    const statusText = t.deviceId ? 'Terpakai' : 'Tersedia';

                    tbody.innerHTML += `
                        <tr>
                            <td><code>${doc.id}</code></td>
                            <td>${roomName}</td>
                            <td><span class="badge ${status}">${statusText}</span></td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn-icon copy" onclick="copyToken('${doc.id}')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="btn-icon delete" onclick="deleteToken('watchTokens', '${doc.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }

            } catch (error) { 
                showToast('Error', 'Gagal memuat token', 'error'); 
            }
        }

        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('usersTableBody');
                const now = new Date();

                if (snapshot.empty) { 
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-users"></i><br>Belum ada user</td></tr>'; 
                    return; 
                }

                tbody.innerHTML = '';
                for (const doc of snapshot.docs) {
                    const u = doc.data();
                    let status = 'Tidak Aktif', statusClass = 'offline';

                    if (u.membershipToken) {
                        const tokenDoc = await db.collection('membershipTokens').doc(u.membershipToken).get();
                        if (tokenDoc.exists) {
                            const exp = tokenDoc.data().expiryDate?.toDate();
                            if (exp && exp > now) { 
                                status = 'Member'; 
                                statusClass = 'active'; 
                            } else { 
                                status = 'Expired'; 
                                statusClass = 'expired'; 
                            }
                        }
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${u.name || '-'}</strong></td>
                            <td>${u.whatsapp || '-'}</td>
                            <td>${u.gender || '-'}</td>
                            <td><code>${u.membershipToken || '-'}</code></td>
                            <td><span class="badge ${statusClass}">${status}</span></td>
                        </tr>
                    `;
                }

            } catch (error) { 
                showToast('Error', 'Gagal memuat users', 'error'); 
            }
        }

        async function deleteToken(collection, tokenId) {
            if (!confirm('Yakin hapus token ini?')) return;
            try {
                await db.collection(collection).doc(tokenId).delete();
                showToast('Sukses', 'Token dihapus', 'success');
                if (collection === 'membershipTokens') loadMembershipTokens();
                else loadWatchTokens();
            } catch (error) { 
                showToast('Error', error.message, 'error'); 
            }
        }

        function generateToken(length = 12) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let token = '';
            for (let i = 0; i < length; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return token;
        }

        async function createMembershipTokens() {
            const duration = parseInt(document.getElementById('membershipDuration').value);
            const count = parseInt(document.getElementById('membershipCount').value);

            try {
                const tokens = [];
                const expiryDate = new Date();
                expiryDate.setMonth(expiryDate.getMonth() + duration);

                for (let i = 0; i < count; i++) {
                    const token = 'MBR-' + generateToken();
                    await db.collection('membershipTokens').doc(token).set({ 
                        duration, 
                        expiryDate: firebase.firestore.Timestamp.fromDate(expiryDate), 
                        deviceId: null, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    tokens.push(token);
                }

                document.getElementById('generatedMembershipTokens').style.display = 'block';
                document.getElementById('membershipTokensList').innerHTML = tokens.map(t => 
                    `<div class="token-display">
                        <span class="token">${t}</span>
                        <button class="btn-copy-sm" onclick="copyToken('${t}')">Copy</button>
                    </div>`
                ).join('');

                showToast('Sukses', `${count} token dibuat`, 'success');
                loadMembershipTokens();

            } catch (error) { 
                showToast('Error', error.message, 'error'); 
            }
        }

        async function createWatchTokens() {
            const roomId = document.getElementById('watchTokenRoom').value;
            const count = parseInt(document.getElementById('watchTokenCount').value);

            if (!roomId) { 
                showToast('Error', 'Pilih room dulu', 'error'); 
                return; 
            }

            try {
                const tokens = [];
                for (let i = 0; i < count; i++) {
                    const token = 'WTC-' + generateToken();
                    await db.collection('watchTokens').doc(token).set({ 
                        roomId, 
                        deviceId: null, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    tokens.push(token);
                }

                document.getElementById('generatedWatchTokens').style.display = 'block';
                document.getElementById('watchTokensList').innerHTML = tokens.map(t => 
                    `<div class="token-display">
                        <span class="token">${t}</span>
                        <button class="btn-copy-sm" onclick="copyToken('${t}')">Copy</button>
                    </div>`
                ).join('');

                showToast('Sukses', `${count} token dibuat`, 'success');
                loadWatchTokens();

            } catch (error) { 
                showToast('Error', error.message, 'error'); 
            }
        }

        function copyToken(token) { 
            navigator.clipboard.writeText(token); 
            showToast('Sukses', 'Token disalin', 'success'); 
        }

        // ==================== DASHBOARD ====================
        async function loadDashboardData() {
            try {
                const [liveRooms, memberships, watchTokens] = await Promise.all([
                    db.collection('rooms').where('isLive', '==', true).get(),
                    db.collection('membershipTokens').get(),
                    db.collection('watchTokens').where('deviceId', '==', null).get()
                ]);

                document.getElementById('statLiveRooms').textContent = liveRooms.size;
                
                let totalViewers = 0;
                liveRooms.forEach(doc => totalViewers += doc.data().viewerCount || 0);
                document.getElementById('statViewers').textContent = totalViewers;

                const now = new Date();
                let activeMembers = 0;
                memberships.forEach(doc => {
                    const d = doc.data();
                    if (d.deviceId && d.expiryDate?.toDate() > now) activeMembers++;
                });
                
                document.getElementById('statMembers').textContent = activeMembers;
                document.getElementById('statTokens').textContent = watchTokens.size;

            } catch (error) { 
                console.error('Dashboard error:', error); 
            }
        }

        // ==================== DELETE ALL ====================
        async function confirmDeleteAll(collection) {
            pendingDeleteCollection = collection;
            try {
                const snapshot = await db.collection(collection).get();
                const count = snapshot.size;

                document.getElementById('deleteCollectionName').textContent = collectionNames[collection];
                document.getElementById('deleteCount').textContent = count;

                if (count === 0) {
                    showToast('Info', `Tidak ada ${collectionNames[collection]} untuk dihapus`, 'info');
                    return;
                }

                openModal('deleteAllModal');

            } catch (error) { 
                showToast('Error', 'Gagal memuat data', 'error'); 
            }
        }

        async function executeDeleteAll() {
            if (!pendingDeleteCollection) return;

            const btn = document.getElementById('btnConfirmDelete');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div> Menghapus...';

            try {
                const collection = pendingDeleteCollection;
                const snapshot = await db.collection(collection).get();

                for (const doc of snapshot.docs) {
                    if (collection === 'rooms') {
                        await deleteRoomSubcollections(doc.id);
                    }
                    await doc.ref.delete();
                }

                closeModal('deleteAllModal');
                showToast('Sukses', `Semua ${collectionNames[collection]} berhasil dihapus`, 'success');

                loadDashboardData();
                switch(collection) {
                    case 'rooms': 
                        loadRooms(); 
                        loadRoomsForSelect(); 
                        break;
                    case 'membershipTokens': 
                        loadMembershipTokens(); 
                        break;
                    case 'watchTokens': 
                        loadWatchTokens(); 
                        break;
                    case 'users': 
                        loadUsers(); 
                        break;
                }

            } catch (error) { 
                showToast('Error', 'Gagal menghapus: ' + error.message, 'error'); 
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash-alt"></i> Hapus Semua';
                pendingDeleteCollection = null;
            }
        }

        // ==================== PHOTO PREVIEW ====================
        function previewMemberPhoto() {
            const url = document.getElementById('memberPhoto').value;
            const preview = document.getElementById('memberPhotoPreview');
            
            if (url) {
                preview.innerHTML = `<img src="${url}" alt="Preview" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\'fas fa-user\'></i>';">`;
            } else {
                preview.innerHTML = '<i class="fas fa-user"></i>';
            }
        }

        function previewEditMemberPhoto() {
            const url = document.getElementById('editMemberPhoto').value;
            const preview = document.getElementById('editMemberPhotoPreview');
            
            if (url) {
                preview.innerHTML = `<img src="${url}" alt="Preview" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\'fas fa-user\'></i>';">`;
            } else {
                preview.innerHTML = '<i class="fas fa-user"></i>';
            }
        }

        // ==================== CLEANUP ====================
        function cleanupAllListeners() {
            if (roomUnsubscriber) roomUnsubscriber();
            if (viewersUnsubscriber) viewersUnsubscriber();
            if (lineupUnsubscriber) lineupUnsubscriber();
            stopDurationCounter();
        }

        // ==================== MODAL CLOSE ON OVERLAY ====================
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => { 
                if (e.target === overlay) overlay.classList.remove('active'); 
            });
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanupAllListeners);
    </script>
</body>
</html>