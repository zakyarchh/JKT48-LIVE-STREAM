<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel | ikazz - 48</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #E85D75;
            --primary-light: #FF8A9B;
            --secondary: #7C6AEF;
            --accent: #2DCDA7;
            --dark: #1E1E2E;
            --gray-700: #4A4A5A;
            --gray-500: #6E6E7E;
            --gray-300: #A0A0B0;
            --gray-100: #F0F0F5;
            --white: #FFFFFF;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(180deg, #FFFFFF 0%, #F8F9FC 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .login-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 48px;
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.6s ease;
        }

        .login-header { text-align: center; margin-bottom: 36px; }

        .login-logo {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 28px;
            font-weight: 800;
            color: white;
        }

        .login-title { font-size: 26px; font-weight: 800; margin-bottom: 8px; }
        .login-subtitle { font-size: 14px; color: var(--gray-500); }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: var(--dark); margin-bottom: 8px; }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--gray-100);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(232, 93, 117, 0.1);
        }

        .btn-login, .btn-primary {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-login:hover, .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 93, 117, 0.4);
        }

        .btn-login:disabled, .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            padding: 12px 20px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover { background: #E8E8F0; }
        .btn-success { background: linear-gradient(135deg, var(--accent) 0%, #25B897 100%) !important; }
        .btn-danger { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%) !important; }

        .admin-container { display: none; min-height: 100vh; }
        .admin-container.active { display: flex; }

        .sidebar {
            width: 260px;
            background: var(--white);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 100;
            animation: slideIn 0.5s ease;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--gray-100);
        }

        .sidebar-logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 16px;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-section { margin-bottom: 28px; }
        .nav-section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 4px;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 14px;
        }

        .nav-item:hover { background: var(--gray-100); color: var(--dark); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; }
        .nav-item i { width: 20px; text-align: center; }

        .btn-logout {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
            background: rgba(232, 93, 117, 0.1);
            border: none;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .btn-logout:hover { background: rgba(232, 93, 117, 0.2); }

        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 32px;
            animation: fadeIn 0.5s ease;
        }

        .page-header { margin-bottom: 28px; }
        .page-title { font-size: 26px; font-weight: 800; margin-bottom: 6px; }
        .page-subtitle { font-size: 14px; color: var(--gray-500); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            animation: fadeInUp 0.5s ease;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 16px;
        }

        .stat-icon.pink { background: rgba(232, 93, 117, 0.1); color: var(--primary); }
        .stat-icon.purple { background: rgba(124, 106, 239, 0.1); color: var(--secondary); }
        .stat-icon.green { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .stat-icon.orange { background: rgba(255, 159, 67, 0.1); color: #FF9F43; }

        .stat-value { font-size: 32px; font-weight: 800; margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: var(--gray-500); font-weight: 500; }

        .content-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            animation: fadeInUp 0.5s ease;
        }

        .content-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .content-card-title { font-size: 18px; font-weight: 700; }

        .table-container { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
        }

        th {
            font-weight: 600;
            color: var(--gray-500);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #FAFBFC;
        }

        td { font-size: 14px; }
        tr:hover td { background: #FAFBFC; }

        code {
            background: var(--gray-100);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge.live { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .badge.offline { background: var(--gray-100); color: var(--gray-500); }
        .badge.active { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .badge.expired { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .badge.used { background: rgba(124, 106, 239, 0.1); color: var(--secondary); }

        .action-btns { display: flex; gap: 8px; }

        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        .btn-icon.copy { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .btn-icon.delete { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .btn-icon:hover { transform: scale(1.1); }

        .stream-preview {
            background: #000;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/9;
            margin-bottom: 20px;
        }

        .stream-preview video { width: 100%; height: 100%; object-fit: cover; }

        .stream-status {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            padding: 8px 14px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stream-status.live { background: #EF4444; animation: pulse 2s infinite; }

        .stream-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .token-display {
            background: var(--gray-100);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: 600;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .token-display .token { letter-spacing: 1px; word-break: break-all; }

        .btn-copy-sm {
            padding: 8px 14px;
            background: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-copy-sm:hover { background: var(--primary); color: white; }

        .page-section { display: none; }
        .page-section.active { display: block; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--white);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 28px;
            transform: scale(0.9) translateY(20px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .modal { transform: scale(1) translateY(0); }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title { font-size: 20px; font-weight: 700; }

        .btn-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--gray-100);
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            color: var(--gray-500);
            transition: all 0.3s ease;
        }

        .btn-close:hover { background: #E8E8F0; transform: rotate(90deg); }

        .modal-body { margin-bottom: 24px; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; }

        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }

        .toast {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            animation: fadeInUp 0.4s ease;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }

        .toast.error { border-left-color: #EF4444; }

        .toast-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .toast.success .toast-icon { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .toast.error .toast-icon { background: rgba(239, 68, 68, 0.1); color: #EF4444; }

        .toast-content h4 { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
        .toast-content p { font-size: 13px; color: var(--gray-500); }

        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .mobile-menu-btn { display: flex !important; }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 22px;
            cursor: pointer;
            z-index: 99;
            box-shadow: 0 4px 20px rgba(232, 93, 117, 0.4);
            align-items: center;
            justify-content: center;
        }

        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
        .sidebar-overlay.active { display: block; }

        .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .empty-state { text-align: center; padding: 48px 20px; color: var(--gray-500); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">48</div>
                <h1 class="login-title">Admin Panel</h1>
                <p class="login-subtitle">Masuk untuk mengelola ikazz - 48</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="adminEmail" placeholder="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="adminPassword" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn-login" id="btnLogin">
                    <i class="fas fa-sign-in-alt"></i> Masuk
                </button>
            </form>
        </div>
    </div>

    <div class="admin-container" id="adminContainer">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">48</div>
                <span class="sidebar-logo-text">ikazz - 48</span>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Menu</div>
                <div class="nav-item active" onclick="showPage('dashboard', this)">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                <div class="nav-item" onclick="showPage('streaming', this)">
                    <i class="fas fa-broadcast-tower"></i> Live Streaming
                </div>
                <div class="nav-item" onclick="showPage('rooms', this)">
                    <i class="fas fa-door-open"></i> Kelola Room
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Token</div>
                <div class="nav-item" onclick="showPage('membership', this)">
                    <i class="fas fa-crown"></i> Token Membership
                </div>
                <div class="nav-item" onclick="showPage('watchTokens', this)">
                    <i class="fas fa-ticket-alt"></i> Token Nonton
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Data</div>
                <div class="nav-item" onclick="showPage('users', this)">
                    <i class="fas fa-users"></i> Users
                </div>
            </div>

            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Keluar
            </button>
        </aside>

        <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <main class="main-content">
            <div class="page-section active" id="page-dashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Selamat datang di panel admin ikazz - 48</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon pink"><i class="fas fa-video"></i></div>
                        <div class="stat-value" id="statLiveRooms">0</div>
                        <div class="stat-label">Room Live</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple"><i class="fas fa-eye"></i></div>
                        <div class="stat-value" id="statViewers">0</div>
                        <div class="stat-label">Total Viewers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-crown"></i></div>
                        <div class="stat-value" id="statMembers">0</div>
                        <div class="stat-label">Members Aktif</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fas fa-ticket-alt"></i></div>
                        <div class="stat-value" id="statTokens">0</div>
                        <div class="stat-label">Token Tersedia</div>
                    </div>
                </div>
            </div>

            <div class="page-section" id="page-streaming">
                <div class="page-header">
                    <h1 class="page-title">Live Streaming</h1>
                    <p class="page-subtitle">Mulai atau kelola live streaming</p>
                </div>
                <div class="content-card">
                    <div class="stream-preview">
                        <video id="localVideo" autoplay muted playsinline></video>
                        <div class="stream-status" id="streamStatus">Offline</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pilih Room</label>
                        <select class="form-select" id="streamRoomSelect">
                            <option value="">-- Pilih Room --</option>
                        </select>
                    </div>
                    <div class="stream-controls">
                        <button class="btn-primary btn-success" onclick="startScreenShare()">
                            <i class="fas fa-desktop"></i> Screen
                        </button>
                        <button class="btn-primary" onclick="startCameraShare()">
                            <i class="fas fa-camera"></i> Camera
                        </button>
                        <button class="btn-primary btn-danger" onclick="startLive()" id="btnGoLive">
                            <i class="fas fa-broadcast-tower"></i> Go Live
                        </button>
                        <button class="btn-secondary" onclick="stopLive()" id="btnStopLive" style="display: none;">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </div>
            </div>

            <div class="page-section" id="page-rooms">
                <div class="page-header">
                    <h1 class="page-title">Kelola Room</h1>
                    <p class="page-subtitle">Buat dan kelola room streaming</p>
                </div>
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title">Daftar Room</h3>
                        <button class="btn-primary" onclick="openModal('createRoomModal')">
                            <i class="fas fa-plus"></i> Buat Room
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Member</th><th>Judul</th><th>Status</th><th>Viewers</th><th>Aksi</th></tr></thead>
                            <tbody id="roomsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="page-section" id="page-membership">
                <div class="page-header">
                    <h1 class="page-title">Token Membership</h1>
                    <p class="page-subtitle">Kelola token membership premium</p>
                </div>
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title">Daftar Token</h3>
                        <button class="btn-primary" onclick="openModal('createMembershipModal')">
                            <i class="fas fa-plus"></i> Buat Token
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Token</th><th>Durasi</th><th>Status</th><th>Expired</th><th>Aksi</th></tr></thead>
                            <tbody id="membershipTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="page-section" id="page-watchTokens">
                <div class="page-header">
                    <h1 class="page-title">Token Nonton</h1>
                    <p class="page-subtitle">Kelola token untuk menonton live</p>
                </div>
                <div class="content-card">
                    <div class="content-card-header">
                        <h3 class="content-card-title">Daftar Token</h3>
                        <button class="btn-primary" onclick="openModal('createWatchTokenModal')">
                            <i class="fas fa-plus"></i> Buat Token
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Token</th><th>Room</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody id="watchTokensTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="page-section" id="page-users">
                <div class="page-header">
                    <h1 class="page-title">Users</h1>
                    <p class="page-subtitle">Lihat data pengguna</p>
                </div>
                <div class="content-card">
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Nama</th><th>WhatsApp</th><th>Gender</th><th>Token</th><th>Status</th></tr></thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="createRoomModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Buat Room Baru</h3>
                <button class="btn-close" onclick="closeModal('createRoomModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nama Member</label>
                    <input type="text" class="form-input" id="roomMemberName" placeholder="Contoh: Shani JKT48" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Judul Stream</label>
                    <input type="text" class="form-input" id="roomTitle" placeholder="Contoh: Cuap-cuap Sore" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Thumbnail URL (opsional)</label>
                    <input type="url" class="form-input" id="roomThumbnail" placeholder="https://...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('createRoomModal')">Batal</button>
                <button class="btn-primary" onclick="createRoom()"><i class="fas fa-plus"></i> Buat</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createMembershipModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Buat Token Membership</h3>
                <button class="btn-close" onclick="closeModal('createMembershipModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Durasi (Bulan)</label>
                    <select class="form-select" id="membershipDuration">
                        <option value="1">1 Bulan</option>
                        <option value="3">3 Bulan</option>
                        <option value="6">6 Bulan</option>
                        <option value="12">12 Bulan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Jumlah Token</label>
                    <input type="number" class="form-input" id="membershipCount" value="1" min="1" max="50">
                </div>
                <div id="generatedMembershipTokens" style="display: none;">
                    <label class="form-label">Token yang Dibuat:</label>
                    <div id="membershipTokensList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('createMembershipModal')">Tutup</button>
                <button class="btn-primary" onclick="createMembershipTokens()"><i class="fas fa-plus"></i> Generate</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createWatchTokenModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Buat Token Nonton</h3>
                <button class="btn-close" onclick="closeModal('createWatchTokenModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Pilih Room</label>
                    <select class="form-select" id="watchTokenRoom"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Jumlah Token</label>
                    <input type="number" class="form-input" id="watchTokenCount" value="1" min="1" max="50">
                </div>
                <div id="generatedWatchTokens" style="display: none;">
                    <label class="form-label">Token yang Dibuat:</label>
                    <div id="watchTokensList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('createWatchTokenModal')">Tutup</button>
                <button class="btn-primary" onclick="createWatchTokens()"><i class="fas fa-plus"></i> Generate</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAl6WmsHrmYkyotYYu_VIEqX5buTrMa-ec",
            authDomain: "live-abd72.firebaseapp.com",
            projectId: "live-abd72",
            storageBucket: "live-abd72.firebasestorage.app",
            messagingSenderId: "705044265931",
            appId: "1:705044265931:web:402b9615df1d38863f944e"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let localStream = null;
        let currentRoomId = null;
        let isLive = false;
        let viewerConnections = {};
        let viewerListeners = [];

        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        auth.onAuthStateChanged((user) => {
            if (user && user.email === 'ikazz@kazz.id') {
                showAdminPanel();
                loadDashboardData();
            } else {
                showLoginPage();
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnLogin');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div> Memproses...';

            try {
                const email = document.getElementById('adminEmail').value;
                const password = document.getElementById('adminPassword').value;
                await auth.signInWithEmailAndPassword(email, password);
                if (auth.currentUser.email !== 'ikazz@kazz.id') {
                    await auth.signOut();
                    throw new Error('Unauthorized');
                }
                showToast('Sukses', 'Login berhasil!', 'success');
            } catch (error) {
                showToast('Error', error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Masuk';
            }
        });

        async function logout() { await stopLive(); await auth.signOut(); }

        function showLoginPage() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').classList.remove('active');
        }

        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').classList.add('active');
        }

        function showPage(pageId, el) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (el) el.classList.add('active');

            switch(pageId) {
                case 'dashboard': loadDashboardData(); break;
                case 'rooms': loadRooms(); break;
                case 'membership': loadMembershipTokens(); break;
                case 'watchTokens': loadWatchTokens(); loadRoomsForSelect(); break;
                case 'users': loadUsers(); break;
                case 'streaming': loadRoomsForSelect(); break;
            }
            if (window.innerWidth <= 1024) toggleSidebar();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<div class="toast-icon"><i class="fas ${type === 'success' ? 'fa-check' : 'fa-exclamation'}"></i></div><div class="toast-content"><h4>${title}</h4><p>${message}</p></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        async function loadDashboardData() {
            try {
                const [liveRooms, memberships, watchTokens] = await Promise.all([
                    db.collection('rooms').where('isLive', '==', true).get(),
                    db.collection('membershipTokens').get(),
                    db.collection('watchTokens').where('deviceId', '==', null).get()
                ]);

                document.getElementById('statLiveRooms').textContent = liveRooms.size;
                let totalViewers = 0;
                liveRooms.forEach(doc => totalViewers += doc.data().viewerCount || 0);
                document.getElementById('statViewers').textContent = totalViewers;

                const now = new Date();
                let activeMembers = 0;
                memberships.forEach(doc => {
                    const d = doc.data();
                    if (d.deviceId && d.expiryDate?.toDate() > now) activeMembers++;
                });
                document.getElementById('statMembers').textContent = activeMembers;
                document.getElementById('statTokens').textContent = watchTokens.size;
            } catch (error) { console.error('Dashboard error:', error); }
        }

        async function loadRooms() {
            try {
                const snapshot = await db.collection('rooms').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('roomsTableBody');
                if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Belum ada room</td></tr>'; return; }
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const r = doc.data();
                    tbody.innerHTML += `<tr><td><strong>${r.memberName || '-'}</strong></td><td>${r.title || '-'}</td><td><span class="badge ${r.isLive ? 'live' : 'offline'}">${r.isLive ? 'LIVE' : 'Offline'}</span></td><td>${r.viewerCount || 0}</td><td><div class="action-btns"><button class="btn-icon delete" onclick="deleteRoom('${doc.id}')"><i class="fas fa-trash"></i></button></div></td></tr>`;
                });
            } catch (error) { showToast('Error', 'Gagal memuat rooms', 'error'); }
        }

        async function loadRoomsForSelect() {
            try {
                const snapshot = await db.collection('rooms').get();
                const streamSelect = document.getElementById('streamRoomSelect');
                const watchSelect = document.getElementById('watchTokenRoom');
                let options = '<option value="">-- Pilih Room --</option>';
                snapshot.forEach(doc => {
                    const r = doc.data();
                    options += `<option value="${doc.id}">${r.memberName} - ${r.title}</option>`;
                });
                streamSelect.innerHTML = options;
                if (watchSelect) watchSelect.innerHTML = options;
            } catch (error) { console.error('Error loading rooms:', error); }
        }

        async function loadMembershipTokens() {
            try {
                const snapshot = await db.collection('membershipTokens').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('membershipTableBody');
                const now = new Date();
                if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Belum ada token</td></tr>'; return; }
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const expiry = t.expiryDate?.toDate();
                    const isExpired = expiry && expiry < now;
                    const isActive = t.deviceId && !isExpired;
                    const status = isActive ? 'active' : (isExpired ? 'expired' : 'offline');
                    const statusText = isActive ? 'Aktif' : (isExpired ? 'Expired' : 'Tersedia');
                    tbody.innerHTML += `<tr><td><code>${doc.id}</code></td><td>${t.duration} Bulan</td><td><span class="badge ${status}">${statusText}</span></td><td>${expiry ? expiry.toLocaleDateString('id-ID') : '-'}</td><td><div class="action-btns"><button class="btn-icon copy" onclick="copyToken('${doc.id}')"><i class="fas fa-copy"></i></button><button class="btn-icon delete" onclick="deleteToken('membershipTokens', '${doc.id}')"><i class="fas fa-trash"></i></button></div></td></tr>`;
                });
            } catch (error) { showToast('Error', 'Gagal memuat token', 'error'); }
        }

        async function loadWatchTokens() {
            try {
                const snapshot = await db.collection('watchTokens').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('watchTokensTableBody');
                if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Belum ada token</td></tr>'; return; }
                tbody.innerHTML = '';
                for (const doc of snapshot.docs) {
                    const t = doc.data();
                    let roomName = '-';
                    if (t.roomId) {
                        const roomDoc = await db.collection('rooms').doc(t.roomId).get();
                        if (roomDoc.exists) roomName = roomDoc.data().memberName;
                    }
                    const status = t.deviceId ? 'used' : 'active';
                    const statusText = t.deviceId ? 'Terpakai' : 'Tersedia';
                    tbody.innerHTML += `<tr><td><code>${doc.id}</code></td><td>${roomName}</td><td><span class="badge ${status}">${statusText}</span></td><td><div class="action-btns"><button class="btn-icon copy" onclick="copyToken('${doc.id}')"><i class="fas fa-copy"></i></button><button class="btn-icon delete" onclick="deleteToken('watchTokens', '${doc.id}')"><i class="fas fa-trash"></i></button></div></td></tr>`;
                }
            } catch (error) { showToast('Error', 'Gagal memuat token', 'error'); }
        }

        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('usersTableBody');
                const now = new Date();
                if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Belum ada user</td></tr>'; return; }
                tbody.innerHTML = '';
                for (const doc of snapshot.docs) {
                    const u = doc.data();
                    let status = 'Tidak Aktif', statusClass = 'offline';
                    if (u.membershipToken) {
                        const tokenDoc = await db.collection('membershipTokens').doc(u.membershipToken).get();
                        if (tokenDoc.exists) {
                            const exp = tokenDoc.data().expiryDate?.toDate();
                            if (exp && exp > now) { status = 'Member'; statusClass = 'active'; }
                            else { status = 'Expired'; statusClass = 'expired'; }
                        }
                    }
                    tbody.innerHTML += `<tr><td><strong>${u.name || '-'}</strong></td><td>${u.whatsapp || '-'}</td><td>${u.gender || '-'}</td><td><code>${u.membershipToken || '-'}</code></td><td><span class="badge ${statusClass}">${status}</span></td></tr>`;
                }
            } catch (error) { showToast('Error', 'Gagal memuat users', 'error'); }
        }

        async function createRoom() {
            const memberName = document.getElementById('roomMemberName').value.trim();
            const title = document.getElementById('roomTitle').value.trim();
            const thumbnail = document.getElementById('roomThumbnail').value.trim();
            if (!memberName || !title) { showToast('Error', 'Nama dan judul wajib diisi', 'error'); return; }
            try {
                await db.collection('rooms').add({ memberName, title, thumbnail: thumbnail || null, isLive: false, viewerCount: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                closeModal('createRoomModal');
                document.getElementById('roomMemberName').value = '';
                document.getElementById('roomTitle').value = '';
                document.getElementById('roomThumbnail').value = '';
                showToast('Sukses', 'Room berhasil dibuat', 'success');
                loadRooms();
                loadRoomsForSelect();
            } catch (error) { showToast('Error', error.message, 'error'); }
        }

        async function deleteRoom(roomId) {
            if (!confirm('Yakin hapus room ini?')) return;
            try { await db.collection('rooms').doc(roomId).delete(); showToast('Sukses', 'Room dihapus', 'success'); loadRooms(); }
            catch (error) { showToast('Error', error.message, 'error'); }
        }

        async function deleteToken(collection, tokenId) {
            if (!confirm('Yakin hapus token ini?')) return;
            try {
                await db.collection(collection).doc(tokenId).delete();
                showToast('Sukses', 'Token dihapus', 'success');
                if (collection === 'membershipTokens') loadMembershipTokens();
                else loadWatchTokens();
            } catch (error) { showToast('Error', error.message, 'error'); }
        }

        function generateToken(length = 12) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let token = '';
            for (let i = 0; i < length; i++) token += chars.charAt(Math.floor(Math.random() * chars.length));
            return token;
        }

        async function createMembershipTokens() {
            const duration = parseInt(document.getElementById('membershipDuration').value);
            const count = parseInt(document.getElementById('membershipCount').value);
            try {
                const tokens = [];
                const expiryDate = new Date();
                expiryDate.setMonth(expiryDate.getMonth() + duration);
                for (let i = 0; i < count; i++) {
                    const token = 'MBR-' + generateToken();
                    await db.collection('membershipTokens').doc(token).set({ duration, expiryDate: firebase.firestore.Timestamp.fromDate(expiryDate), deviceId: null, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    tokens.push(token);
                }
                document.getElementById('generatedMembershipTokens').style.display = 'block';
                document.getElementById('membershipTokensList').innerHTML = tokens.map(t => `<div class="token-display"><span class="token">${t}</span><button class="btn-copy-sm" onclick="copyToken('${t}')">Copy</button></div>`).join('');
                showToast('Sukses', `${count} token dibuat`, 'success');
                loadMembershipTokens();
            } catch (error) { showToast('Error', error.message, 'error'); }
        }

        async function createWatchTokens() {
            const roomId = document.getElementById('watchTokenRoom').value;
            const count = parseInt(document.getElementById('watchTokenCount').value);
            if (!roomId) { showToast('Error', 'Pilih room dulu', 'error'); return; }
            try {
                const tokens = [];
                for (let i = 0; i < count; i++) {
                    const token = 'WTC-' + generateToken();
                    await db.collection('watchTokens').doc(token).set({ roomId, deviceId: null, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    tokens.push(token);
                }
                document.getElementById('generatedWatchTokens').style.display = 'block';
                document.getElementById('watchTokensList').innerHTML = tokens.map(t => `<div class="token-display"><span class="token">${t}</span><button class="btn-copy-sm" onclick="copyToken('${t}')">Copy</button></div>`).join('');
                showToast('Sukses', `${count} token dibuat`, 'success');
                loadWatchTokens();
            } catch (error) { showToast('Error', error.message, 'error'); }
        }

        function copyToken(token) { navigator.clipboard.writeText(token); showToast('Sukses', 'Token disalin', 'success'); }

        async function startScreenShare() {
            try {
                if (localStream) localStream.getTracks().forEach(t => t.stop());
                localStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: 'always', width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: { echoCancellation: true, noiseSuppression: true } });
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('streamStatus').textContent = 'Preview';
                document.getElementById('streamStatus').classList.remove('live');
                showToast('Sukses', 'Screen share aktif', 'success');
                localStream.getVideoTracks()[0].onended = () => stopLocalStream();
            } catch (error) { showToast('Error', 'Gagal share screen: ' + error.message, 'error'); }
        }

        async function startCameraShare() {
            try {
                if (localStream) localStream.getTracks().forEach(t => t.stop());
                localStream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: { echoCancellation: true, noiseSuppression: true } });
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('streamStatus').textContent = 'Preview';
                document.getElementById('streamStatus').classList.remove('live');
                showToast('Sukses', 'Camera aktif', 'success');
            } catch (error) { showToast('Error', 'Gagal akses camera: ' + error.message, 'error'); }
        }

        function stopLocalStream() {
            if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('streamStatus').textContent = 'Offline';
            document.getElementById('streamStatus').classList.remove('live');
        }

        async function startLive() {
            const roomId = document.getElementById('streamRoomSelect').value;
            if (!roomId) { showToast('Error', 'Pilih room dulu', 'error'); return; }
            if (!localStream) { showToast('Error', 'Mulai screen/camera dulu', 'error'); return; }
            try {
                currentRoomId = roomId;
                isLive = true;
                await db.collection('rooms').doc(roomId).update({ isLive: true, viewerCount: 0, startTime: firebase.firestore.FieldValue.serverTimestamp() });

                const viewersRef = db.collection('rooms').doc(roomId).collection('viewers');
                const unsubscribe = viewersRef.onSnapshot(async (snapshot) => {
                    for (const change of snapshot.docChanges()) {
                        if (change.type === 'added') await handleNewViewer(roomId, change.doc.id);
                    }
                });
                viewerListeners.push(unsubscribe);

                document.getElementById('streamStatus').textContent = 'LIVE';
                document.getElementById('streamStatus').classList.add('live');
                document.getElementById('btnGoLive').style.display = 'none';
                document.getElementById('btnStopLive').style.display = 'inline-flex';
                showToast('Sukses', 'Live dimulai!', 'success');
                loadDashboardData();
            } catch (error) { showToast('Error', error.message, 'error'); }
        }

        async function handleNewViewer(roomId, viewerId) {
            try {
                const pc = new RTCPeerConnection(rtcConfig);
                viewerConnections[viewerId] = pc;
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

                pc.onicecandidate = async (event) => {
                    if (event.candidate) {
                        await db.collection('rooms').doc(roomId).collection('viewers').doc(viewerId).collection('broadcasterCandidates').add(event.candidate.toJSON());
                    }
                };

                db.collection('rooms').doc(roomId).collection('viewers').doc(viewerId).collection('viewerCandidates').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            try { await pc.addIceCandidate(new RTCIceCandidate(change.doc.data())); } catch (e) {}
                        }
                    });
                });

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                await db.collection('rooms').doc(roomId).collection('viewers').doc(viewerId).update({ offer: { type: offer.type, sdp: offer.sdp } });

                db.collection('rooms').doc(roomId).collection('viewers').doc(viewerId).onSnapshot(async (doc) => {
                    const data = doc.data();
                    if (data?.answer && !pc.currentRemoteDescription) {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });
            } catch (error) { console.error('Error handling viewer:', error); }
        }

        async function stopLive() {
            if (!currentRoomId) return;
            try {
                viewerListeners.forEach(unsub => unsub());
                viewerListeners = [];
                Object.values(viewerConnections).forEach(pc => pc.close());
                viewerConnections = {};

                await db.collection('rooms').doc(currentRoomId).update({ isLive: false });

                const viewers = await db.collection('rooms').doc(currentRoomId).collection('viewers').get();
                for (const doc of viewers.docs) {
                    const bcCands = await doc.ref.collection('broadcasterCandidates').get();
                    bcCands.forEach(c => c.ref.delete());
                    const vCands = await doc.ref.collection('viewerCandidates').get();
                    vCands.forEach(c => c.ref.delete());
                    await doc.ref.delete();
                }

                stopLocalStream();
                currentRoomId = null;
                isLive = false;
                document.getElementById('btnGoLive').style.display = 'inline-flex';
                document.getElementById('btnStopLive').style.display = 'none';
                showToast('Sukses', 'Live dihentikan', 'success');
                loadDashboardData();
            } catch (error) { showToast('Error', error.message, 'error'); }
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('active'); });
        });
    </script>
</body>
</html>