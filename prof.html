<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profil | ikazz - 48</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #E85D75;
            --primary-light: #FF8A9B;
            --secondary: #7C6AEF;
            --accent: #2DCDA7;
            --dark: #1E1E2E;
            --gray-700: #4A4A5A;
            --gray-500: #6E6E7E;
            --gray-300: #A0A0B0;
            --gray-100: #F0F0F5;
            --white: #FFFFFF;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(180deg, #FFFFFF 0%, #F8F9FC 100%);
            min-height: 100vh;
            color: var(--dark);
            padding-bottom: 90px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--white);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .loading-screen.hidden { opacity: 0; visibility: hidden; }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--gray-100);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-text { margin-top: 16px; font-size: 14px; color: var(--gray-500); font-weight: 500; }

        .header {
            background: var(--white);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.04);
            animation: fadeIn 0.5s ease;
        }

        .header-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 14px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .profile-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 32px 24px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            animation: fadeInUp 0.5s ease;
        }

        .profile-header { text-align: center; margin-bottom: 28px; }

        .profile-avatar {
            width: 88px;
            height: 88px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 36px;
            color: white;
        }

        .profile-name { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
        .profile-name.empty { color: var(--gray-500); }

        .membership-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
        }

        .membership-badge.active {
            background: linear-gradient(135deg, var(--accent) 0%, #25B897 100%);
            color: white;
        }

        .membership-badge.inactive { background: var(--gray-100); color: var(--gray-500); }
        .membership-badge.expired { background: rgba(239, 68, 68, 0.1); color: #EF4444; }

        .membership-info {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--radius-lg);
            padding: 24px;
            color: white;
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
        }

        .membership-info::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            pointer-events: none;
        }

        .membership-info-content { position: relative; z-index: 1; }

        .membership-info h3 {
            font-size: 13px;
            font-weight: 600;
            opacity: 0.9;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .membership-info .expiry { font-size: 22px; font-weight: 800; }
        .membership-info .days-left { font-size: 14px; opacity: 0.9; margin-top: 8px; }

        .form-section { animation: fadeInUp 0.5s ease 0.1s both; }
        .form-section-title { font-size: 17px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .form-section-title i { color: var(--primary); }

        .form-group { margin-bottom: 18px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--dark); margin-bottom: 8px; }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--gray-100);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(232, 93, 117, 0.1);
        }

        .form-input:disabled { background: var(--gray-100); cursor: not-allowed; }

        .btn-primary {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(232, 93, 117, 0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-secondary {
            width: 100%;
            padding: 14px 24px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }

        .btn-secondary:hover { background: #E8E8F0; }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

        .not-logged-in { text-align: center; padding: 48px 20px; }

        .not-logged-in-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--gray-100) 0%, #E8E8F0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 40px;
            color: var(--gray-300);
        }

        .not-logged-in h2 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .not-logged-in p { font-size: 14px; color: var(--gray-500); margin-bottom: 24px; max-width: 280px; margin-left: auto; margin-right: auto; line-height: 1.6; }

        .divider { height: 1px; background: var(--gray-100); margin: 24px 0; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 10px 20px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid rgba(0,0,0,0.04);
            z-index: 100;
        }

        .nav-content { max-width: 400px; margin: 0 auto; display: flex; justify-content: space-around; }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 20px;
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--gray-500);
            transition: all 0.3s ease;
        }

        .nav-item:hover { color: var(--primary); }
        .nav-item.active { color: var(--primary); background: rgba(232, 93, 117, 0.08); }
        .nav-item i { font-size: 20px; }
        .nav-item span { font-size: 11px; font-weight: 600; }

        .toast-container { position: fixed; top: 20px; left: 20px; right: 20px; z-index: 2000; }

        .toast {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: fadeInUp 0.4s ease;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }

        .toast.error { border-left-color: #EF4444; }

        .toast-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .toast.success .toast-icon { background: rgba(45, 205, 167, 0.1); color: var(--accent); }
        .toast.error .toast-icon { background: rgba(239, 68, 68, 0.1); color: #EF4444; }

        .toast-content h4 { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
        .toast-content p { font-size: 13px; color: var(--gray-500); }

        .loading-spinner-sm {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <p class="loading-text">Memuat...</p>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <div class="logo-icon">48</div>
                <span class="logo-text">ikazz - 48</span>
            </a>
        </div>
    </header>

    <main class="main-content">
        <div class="profile-card" id="notLoggedIn" style="display: none;">
            <div class="not-logged-in">
                <div class="not-logged-in-icon">
                    <i class="fas fa-user-lock"></i>
                </div>
                <h2>Belum Login</h2>
                <p>Anda belum memiliki membership aktif. Aktivasi dengan token membership untuk akses tanpa batas.</p>
                <button class="btn-primary" onclick="window.location.href='index.html'">
                    <i class="fas fa-crown"></i> Aktivasi Membership
                </button>
            </div>
        </div>

        <div id="profileContent" style="display: none;">
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 class="profile-name" id="profileName">Nama Pengguna</h2>
                    <div class="membership-badge active" id="membershipBadge">
                        <i class="fas fa-crown"></i>
                        <span>Member Aktif</span>
                    </div>
                </div>

                <div class="membership-info" id="membershipInfo">
                    <div class="membership-info-content">
                        <h3><i class="fas fa-calendar-alt"></i> Berlaku Hingga</h3>
                        <div class="expiry" id="expiryDate">-</div>
                        <div class="days-left" id="daysLeft">-</div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-edit"></i> Informasi Profil
                    </h3>
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-input" id="inputName" placeholder="Masukkan nama lengkap" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Kelamin</label>
                            <select class="form-select" id="inputGender" required>
                                <option value="">Pilih Jenis Kelamin</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nomor WhatsApp</label>
                            <input type="tel" class="form-input" id="inputWhatsapp" placeholder="08123456789" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Token Membership</label>
                            <input type="text" class="form-input" id="inputToken" disabled>
                        </div>
                        <button type="submit" class="btn-primary" id="btnSave">
                            <i class="fas fa-save"></i> Simpan Perubahan
                        </button>
                    </form>

                    <div class="divider"></div>

                    <button class="btn-secondary btn-danger" onclick="logoutMembership()">
                        <i class="fas fa-sign-out-alt"></i> Keluar dari Membership
                    </button>
                </div>
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <div class="nav-content">
            <a href="index.html" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Beranda</span>
            </a>
            <a href="prof.html" class="nav-item active">
                <i class="fas fa-user"></i>
                <span>Profil</span>
            </a>
        </div>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAl6WmsHrmYkyotYYu_VIEqX5buTrMa-ec",
            authDomain: "live-abd72.firebaseapp.com",
            projectId: "live-abd72",
            storageBucket: "live-abd72.firebasestorage.app",
            messagingSenderId: "705044265931",
            appId: "1:705044265931:web:402b9615df1d38863f944e"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        let membershipData = null;

        function getDeviceId() {
            let deviceId = localStorage.getItem('ikazz_device_id');
            if (!deviceId) {
                deviceId = 'DEV_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('ikazz_device_id', deviceId);
            }
            return deviceId;
        }

        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<div class="toast-icon"><i class="fas ${type === 'success' ? 'fa-check' : 'fa-exclamation'}"></i></div><div class="toast-content"><h4>${title}</h4><p>${message}</p></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        async function init() {
            const memberToken = localStorage.getItem('ikazz_membership_token');
            const deviceId = getDeviceId();

            if (!memberToken) {
                showNotLoggedIn();
                hideLoading();
                return;
            }

            try {
                const tokenDoc = await db.collection('membershipTokens').doc(memberToken).get();

                if (!tokenDoc.exists) {
                    localStorage.removeItem('ikazz_membership_token');
                    showNotLoggedIn();
                    hideLoading();
                    return;
                }

                const tokenData = tokenDoc.data();

                if (tokenData.deviceId && tokenData.deviceId !== deviceId) {
                    localStorage.removeItem('ikazz_membership_token');
                    showToast('Error', 'Token terikat dengan perangkat lain', 'error');
                    showNotLoggedIn();
                    hideLoading();
                    return;
                }

                const expiryDate = tokenData.expiryDate?.toDate();
                if (expiryDate && expiryDate < new Date()) {
                    showExpired(expiryDate);
                    hideLoading();
                    return;
                }

                membershipData = tokenData;
                membershipData.token = memberToken;

                const userDoc = await db.collection('users').doc(deviceId).get();
                if (userDoc.exists) currentUser = userDoc.data();

                showProfile();
                hideLoading();
            } catch (error) {
                console.error('Init error:', error);
                showToast('Error', 'Gagal memuat profil', 'error');
                hideLoading();
            }
        }

        function showNotLoggedIn() {
            document.getElementById('notLoggedIn').style.display = 'block';
            document.getElementById('profileContent').style.display = 'none';
        }

        function showProfile() {
            document.getElementById('notLoggedIn').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';

            if (currentUser) {
                document.getElementById('inputName').value = currentUser.name || '';
                document.getElementById('inputGender').value = currentUser.gender || '';
                document.getElementById('inputWhatsapp').value = currentUser.whatsapp || '';
                document.getElementById('profileName').textContent = currentUser.name || 'Atur Profil Anda';
                document.getElementById('profileName').classList.toggle('empty', !currentUser.name);
            } else {
                document.getElementById('profileName').textContent = 'Atur Profil Anda';
                document.getElementById('profileName').classList.add('empty');
            }

            document.getElementById('inputToken').value = membershipData.token;

            const expiryDate = membershipData.expiryDate?.toDate();
            if (expiryDate) {
                document.getElementById('expiryDate').textContent = expiryDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const daysLeft = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
                document.getElementById('daysLeft').textContent = `${daysLeft} hari tersisa`;
            }
        }

        function showExpired(expiryDate) {
            document.getElementById('notLoggedIn').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';

            document.getElementById('membershipBadge').className = 'membership-badge expired';
            document.getElementById('membershipBadge').innerHTML = '<i class="fas fa-times-circle"></i><span>Expired</span>';
            document.getElementById('membershipInfo').style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';
            document.getElementById('expiryDate').textContent = 'Membership Berakhir';
            document.getElementById('daysLeft').textContent = expiryDate.toLocaleDateString('id-ID');
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('inputName').value.trim();
            const gender = document.getElementById('inputGender').value;
            const whatsapp = document.getElementById('inputWhatsapp').value.trim();

            if (!name || !gender || !whatsapp) {
                showToast('Error', 'Semua field wajib diisi', 'error');
                return;
            }

            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner-sm"></div> Menyimpan...';

            try {
                const deviceId = getDeviceId();

                await db.collection('users').doc(deviceId).set({
                    name,
                    gender,
                    whatsapp,
                    membershipToken: membershipData.token,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: currentUser?.createdAt || firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                currentUser = { name, gender, whatsapp };
                document.getElementById('profileName').textContent = name;
                document.getElementById('profileName').classList.remove('empty');

                showToast('Sukses', 'Profil berhasil disimpan', 'success');
            } catch (error) {
                console.error('Save error:', error);
                showToast('Error', 'Gagal menyimpan profil', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Simpan Perubahan';
            }
        });

        function logoutMembership() {
            if (!confirm('Yakin ingin keluar dari membership?')) return;

            localStorage.removeItem('ikazz_membership_token');
            showToast('Sukses', 'Berhasil keluar', 'success');
            setTimeout(() => { window.location.href = 'index.html'; }, 1500);
        }

        function hideLoading() {
            setTimeout(() => { document.getElementById('loadingScreen').classList.add('hidden'); }, 300);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>